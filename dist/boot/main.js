/*Auto generated by Kirby - v1.0.0 czlab.kirby.main Thu Dec 14 2017 17:25:16 GMT-0800 (PST)*/

const getopt = require("node-getopt");
const cp = require("child_process");
const watch = require("watch");
const path = require("path");
const fs = require("fs");
const tx = require("./compiler");
const std = require("./stdlib");
const object_QUERY = std["object_QUERY"];
const rt = require("./engine");
const kirbystdlibref = std;
var error_BANG = function() {
  let ____args = Array.prototype.slice.call(arguments);
  return (function() {
    if (console) {
      console.log([____args[0]].join(""));
    }
    return process.exit(1);
  }).call(this);
};
////////////////////////////////////////////////////////////////////////////////
//name: [compileFiles] in file: main.ky near line: 27
const compileFiles = function(opt) {
  let G____9 = opt.argv;
  let fin = G____9[0];
  let fout = G____9[1];
  if ( (!fin) ) {
    error_BANG("No Input file");
  }
  if ( (!fout) ) {
    fout = fin.replace(/\.ky$/, ".js");
    if ( (fout === fin) ) {
      error_BANG("Input file must have extension \".ky\"");
    }
  }
  return (function() {
    try {
      let options = opt.options;
      let G____10 = options;
      let source_DASH_map = G____10["source-map"];
      let format = G____10["format"];
      let show_DASH_ast = G____10["show-ast"];
      if ( (!show_DASH_ast) ) {
        if (console) {
          console.log([["kirby v", tx.version].join(""), ": compiling file: ", fin, " -> ", fout].join(""));
        }
      }
      let ret = null;
      let source = fs.readFileSync(fin, "utf8");
      return (show_DASH_ast ?
        (console ?
          console.log([tx.dbgAST(source, fin)].join("")) :
          null) :
        (function() {
          ret = tx.transpile(source, fin, options);
          fs.writeFileSync(fout, ret[0], "utf-8");
          return (ret[1] ?
            (function() {
              throw ret[1];
            }).call(this) :
            null);
        }).call(this));
    } catch (e) {
      return error_BANG(e);
    }
  }).call(this);
};
////////////////////////////////////////////////////////////////////////////////
//name: [init] in file: main.ky near line: 52
const init = function() {
  require.extensions[".ky"] = function(module, fname) {
    let G____11 = require("./compiler").transpile(fs.readFileSync(fname, "utf8"), path.relative(process.cwd(), fname));
    let code = G____11[0];
    let err = G____11[1];
    return (err ?
      (function() {
        throw err ;
      }).call(this) :
      module._compile(code, fname));
  };
  return rt.init(tx.version);
};
////////////////////////////////////////////////////////////////////////////////
//name: [doWatch] in file: main.ky near line: 67
const doWatch = function(cwd) {
  if (console) {
    console.log(["Watching", cwd, "for \".ky\" file changes..."].join(""));
  }
  return watch.watchTree(cwd, {
    "ignoreDirectoryPattern": /node_modules/,
    "ignoreDotFiles": true,
    "filter": function(f, stat) {
      return (f.endsWith(".ky") || stat.isDirectory());
    }
  }, function(f, curr, prev) {
    return ((object_QUERY(f) && (prev === null) && (curr === null)) ?
      (function() {
        let G__1 = null;
        "finished walking the tree";
        return G__1;
      }).call(this) :
      ((curr && (0 === curr.nlink)) ?
        (function() {
          let G__2 = null;
          "f was removed";
          return G__2;
        }).call(this) :
        (true ?
          (function() {
            return cp.spawn("bin/boot.js", [f.slice((cwd.length + 1))], {
              "stdio": "inherit"
            });
          }).call(this) :
          null)));
  });
};
////////////////////////////////////////////////////////////////////////////////
//name: [pcli] in file: main.ky near line: 94
const pcli = function(gopt) {
  let opt = gopt.parseSystem();
  let G____12 = opt.options;
  let version = G____12["version"];
  let repl = G____12["repl"];
  let watch = G____12["watch"];
  let help = G____12["help"];
  if (version) {
    console.info(tx.version);
  } else {
    if (watch) {
      doWatch(process.cwd());
    } else {
      if (repl) {
        rt.runRepl();
      } else {
        if ( (help || (0 === kirbystdlibref.count(opt.argv))) ) {
          gopt.showHelp();
        } else {
          if (true) {
            compileFiles(opt);
          }
        }
      }
    }
  }
  return true;
};
////////////////////////////////////////////////////////////////////////////////
//name: [main] in file: main.ky near line: 108
const main = function() {
  let gopt = getopt.create([["w", "watch", "auto-compile changed files"], ["m", "source-map", "generate source maps"], ["f", "format", "format source code"], ["b", "bundle", "bundle for browser"], ["h", "help", "display this help"], ["v", "version", "show version"], ["r", "repl", "start a repl"], ["t", "show-ast", "show AST"]]).setHelp(["kirby [OPTIONS] [<infile>] [<outfile>]\n\n", "<outfile> default to <infile> with \".js\" suffix\n\n", "[[OPTIONS]]\n\n"].join("")).bindHelp();
  return (init() && pcli(gopt));
};
main()
module.exports = {
  main: main
};