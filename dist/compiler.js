/*Auto generated by Kirby - v1.0.0 */

;
var _STARpath_STAR = require("path"),
  _STARfs_STAR = require("fs");
var _STARprocess_STAR = process;
require.extensions[".kirby"] = function (module,fname) {
  let kb = require("kirby"),
    code = _STARfs_STAR.readFileSync(fname,"utf8");
  return module._compile(kb.transpile(code,_STARpath_STAR.relative(_STARprocess_STAR.cwd(),fname)),fname);
};
function some_QUERY(obj) {
  return (!((typeof(obj) === "undefined") || (Object.prototype.toString.call(obj) === "[object Null]")));
}
function zero_QUERY(obj) {
  return ((typeof(obj) === "number") ?
    (0 == obj) :
    false);
}
function get_QUERY_QUERY(obj,fld,dft) {
  let x = (obj ?
    obj[fld] :
    undefined);
  return ((typeof(x) === "undefined") ?
    dft :
    x);
}
function contains_QUERY(coll,itm) {
  return (((Object.prototype.toString.call(coll) === "[object Array]") || (typeof(coll) === "string")) ?
    coll.includes(itm) :
    ((Object.prototype.toString.call(coll) === "[object Object]") ?
      Object.keys(coll).includes(itm) :
      (true ?
        false :
        undefined)));
}
function make_array(len,obj) {
  return   (function(____self) {
  let ret = [];
  return   (function(____self) {
  (function (____self) {
for (var i = 0; (i < len); i = (i + 1)) {
        (function(____self) {
    return ret.push(obj);
    })(this);
  }
})(this);
  return ret;
  })(this);
  })(this);
}
function each_key(func,obj) {
  return Object.keys(obj).forEach(function (k) {
    return func(obj[k],k,obj);
  });
}
function last(coll) {
  return (coll ?
    coll[((coll)["length"] - 1)] :
    undefined);
}
function nth(coll,pos) {
  return (coll ?
    coll[pos] :
    undefined);
}
function even_QUERY(n) {
  return ((n % 2) === 0);
}
function odd_QUERY(n) {
  return (!even_QUERY(n));
}
function pos_QUERY(arg) {
  return ((typeof(arg) === "number") && (arg > 0));
}
function neg_QUERY(arg) {
  return ((typeof(arg) === "number") && (arg < 0));
}
function constantly(x) {
  return function () {
    return x;
  };
}
function identity(x) {
  return x;
}
function conj_BANG(c,a) {
  c.push(a);
  return c;
}
function conj_BANG_BANG(c,a) {
  (a ?
    c.push(a) :
    undefined);
  return c;
}
function not_empty(x) {
  return ((x && ((x)["length"] > 0)) ?
    x :
    null);
}
function empty_QUERY(x) {
  return (x ?
    (0 == (x)["length"]) :
    true);
}
function seq(x) {
  return ((typeof(x) === "string") ?
    Array.from(x) :
    ((Object.prototype.toString.call(x) === "[object Array]") ?
      x :
      ((Object.prototype.toString.call(x) === "[object Object]") ?
        Object.entries(x) :
        (true ?
          [] :
          undefined))));
}
var TreeNode = (require("source-map"))["SourceNode"];
var _STARpath_STAR = require("path");
var _STARfs_STAR = require("fs");
var REGEX = {
  "noret": new RegExp("^def\\b|^var\\b|^set!\\b|^throw\\b"),
  "id": new RegExp("^[a-zA-Z_$][?\\-*!0-9a-zA-Z_$]*$"),
  "id2": new RegExp("^[*\\-][?\\-*!0-9a-zA-Z_$]+$"),
  "float": new RegExp("^[-+]?[0-9]+\\.[0-9]+$"),
  "int": new RegExp("^[-+]?[0-9]+$"),
  "hex": new RegExp("^[-+]?0x"),
  "macroGet": new RegExp("^#slice@(\\d+)"),
  "dquoteHat": new RegExp("^\""),
  "dquoteEnd": new RegExp("\"$"),
  "func": new RegExp("^function\\b"),
  "query": new RegExp("\\?","g"),
  "bang": new RegExp("!","g"),
  "dash": new RegExp("-","g"),
  "star": new RegExp("\\*","g"),
  "wspace": new RegExp("\\s")
};
var tkn_string = "STRING";
var tkn_number = "NUMBER";
var tkn_symbol = "SYMBOL";
var tkn_ident = "IDENT";
var tkn_atom = "ATOM";
var tkn_hat = "HAT";
var tkn_quote = "QUOTE";
var tkn_back_tick = "BACKTICK";
var tkn_list = "LIST";
var tkn_tree = "TREE";
var tkn_array = "ARRAY";
var tkn_object = "OBJECT";
function nodeTag(obj,src,line,col,type) {
  (obj ?
        (function(____self) {
    obj["source"] = src;
    obj["column"] = col;
    obj["line"] = line;
    return obj["eTYPE"] = type;
    })(this) :
    undefined);
  return obj;
}
function testid_QUERY(name) {
  return (REGEX.id.test(name) || REGEX.id2.test(name));
}
function normalizeId(name) {
  let pfx = "";
  (((typeof(name) === "string") && ("-" === name.charAt(0))) ?
        (function(____self) {
    pfx = "-";
    return name = name.slice(1);
    })(this) :
    undefined);
  return (testid_QUERY(name) ?
    [pfx,name].join("").replace(REGEX.query,"_QUERY").replace(REGEX.bang,"_BANG").replace(REGEX.dash,"_").replace(REGEX.star,"_STAR") :
    ((pfx === "") ?
      name :
      [pfx,name].join("")));
}
function tnodeString() {
  let me = this;
  return   (function(____self) {
  let s = "";
  return   (function(____self) {
  me.walk(function (chunk,hint) {
    (((hint.name === chunk) && (typeof(chunk) === "string")) ?
      chunk = normalizeId(chunk) :
      undefined);
    return s += chunk;
  });
  return s;
  })(this);
  })(this);
}
function tnode(source,line,col,chunk,name,type) {
  let args_QUERY = ((arguments)["length"] > 0);
  return   (function(____self) {
  let n = null;
  return   (function(____self) {
  (args_QUERY ?
    n = (name ?
      new TreeNode(line,col,source,chunk,name) :
      new TreeNode(line,col,source,chunk)) :
    n = new TreeNode());
  n["eTYPE"] = type;
  n["toString"] = tnodeString;
  return n;
  })(this);
  })(this);
}
function tnodeEx(chunk,name,type) {
  return tnode(null,null,null,chunk,name,type);
}
function addToken(tree,token,ctx) {
  let n = null,
    t = tkn_symbol;
  return   (function(____self) {
  let ret = "";
  return   (function(____self) {
  (token ?
        (function(____self) {
    ((":else" === token) ?
      token = "true" :
      undefined);
    (("nil" === token) ?
      token = "null" :
      undefined);
    ((token.startsWith("\"") && token.endsWith("\"")) ?
      t = tkn_string :
      ((REGEX.float.test(token) || REGEX.int.test(token) || REGEX.hex.test(token)) ?
        t = tkn_number :
        (("^" === token) ?
          t = tkn_hat :
          (("`" === token) ?
            t = tkn_back_tick :
            (token.startsWith(":") ?
              token = ["\"",token.slice(1),"\""].join("") :
              (token.startsWith("'") ?
                token = ["\"",token.slice(1),"\""].join("") :
                (true ?
                  t = tkn_ident :
                  undefined)))))));
    n = tnode(ctx.file,ctx.line,(ctx.tcol - 1),token,token,t);
    return conj_BANG_BANG(tree,n);
    })(this) :
    undefined);
  return ret;
  })(this);
  })(this);
}
function lexer(prevToken,ctx) {
  let ____BREAK_BANG = null,
    formType = null,
    token = "",
    ch = null,
    escStr_QUERY = false,
    inStr_QUERY = false,
    comment_QUERY = false;
  return   (function(____self) {
  let tree = [];
  return   (function(____self) {
  nodeTag(tree,ctx["source"],ctx["line"],0,(("{" === prevToken) ?
    tkn_object :
    (("[" === prevToken) ?
      tkn_array :
      (true ?
        tkn_list :
        undefined))));
  ____BREAK_BANG = false;
  (function (____self) {
while ((!____BREAK_BANG) && (ctx.pos < (ctx.codeStr)["length"])) {
  (function(____self) {
  ch = ctx.codeStr.charAt(ctx.pos);
  ++ctx.colno;
  ++ctx.pos;
  ((ch === "\n") ?
        (function(____self) {
    ++ctx.lineno;
    ctx.colno = 1;
    return (comment_QUERY ?
      comment_QUERY = (!comment_QUERY) :
      undefined);
    })(this) :
    undefined);
  return (comment_QUERY ?
    null :
    (escStr_QUERY ?
            (function(____self) {
      escStr_QUERY = (!escStr_QUERY);
      return token += ch;
      })(this) :
      ((ch === "\"") ?
                (function(____self) {
        inStr_QUERY = (!inStr_QUERY);
        return token += ch;
        })(this) :
        (inStr_QUERY ?
                    (function(____self) {
          ((ch === "\n") ?
            ch = "\\n" :
            undefined);
          ((ch === "\\") ?
            escStr_QUERY = true :
            undefined);
          return token += ch;
          })(this) :
          ((ch === "'") ?
            token += ch :
            (((ch === "[") || (ch === "]")) ?
                            (function(____self) {
              token = addToken(tree,token,ctx);
              ctx.tcol = ctx.colno;
              return ((ch === "[") ?
                                (function(____self) {
                formType = tkn_array;
                return conj_BANG_BANG(tree,lexer(ch,ctx));
                })(this) :
                                (function(____self) {
                formType = null;
                return ____BREAK_BANG = true;
                })(this));
              })(this) :
              (((ch === "{") || (ch === "}")) ?
                                (function(____self) {
                token = addToken(tree,token,ctx);
                ctx.tcol = ctx.colno;
                return ((ch === "{") ?
                                    (function(____self) {
                  formType = tkn_object;
                  return conj_BANG_BANG(tree,lexer(ch,ctx));
                  })(this) :
                                    (function(____self) {
                  formType = null;
                  return ____BREAK_BANG = true;
                  })(this));
                })(this) :
                ((ch === ";") ?
                  comment_QUERY = true :
                  (((ch === "(") || (ch === ")")) ?
                                        (function(____self) {
                    token = addToken(tree,token,ctx);
                    ctx.tcol = ctx.colno;
                    return ((ch === "(") ?
                                            (function(____self) {
                      formType = tkn_list;
                      return conj_BANG_BANG(tree,lexer(null,ctx));
                      })(this) :
                                            (function(____self) {
                      formType = null;
                      return ____BREAK_BANG = true;
                      })(this));
                    })(this) :
                    (REGEX.wspace.test(ch) ?
                                            (function(____self) {
                      ((ch === "\n") ?
                        --ctx.lineno :
                        undefined);
                      token = addToken(tree,token,ctx);
                      ((ch === "\n") ?
                        ++ctx.lineno :
                        undefined);
                      return ctx.tcol = ctx.colno;
                      })(this) :
                      (true ?
                        token += ch :
                        undefined)))))))))));
  })(this);
}
})(this);
  (inStr_QUERY ?
    syntax_BANG("e3",tree) :
    undefined);
  (function(____self) {
switch (formType) {
case tkn_array:
syntax_BANG("e5",tree);
break;
case tkn_object:
syntax_BANG("e7",tree);
break;
case tkn_list:
syntax_BANG("e8",tree);
break;
}
})(this);
  return tree;
  })(this);
  })(this);
}
var MODULE_VERSION = "1.0.0",
  loadedMacros_QUERY = false,
  noSemi_QUERY = false,
  tabspace = 2,
  VARGS = "&rest",
  TILDA = "~",
  indent = (-tabspace),
  TILDA_VARGS = [TILDA,VARGS].join("");
var _STARexterns_STAR = null;
var _STARnspaces_STAR = null;
function banner() {
  return ["/*","Auto generated by Kirby - v",MODULE_VERSION," ","*/\n\n"].join("");
}
var SPECIAL_OPS = {};
var MACROS_MAP = {};
var ERRORS_MAP = {
  "e0": "Syntax Error",
  "e1": "Empty statement",
  "e2": "Invalid characters in function name",
  "e3": "End of File encountered, unterminated string",
  "e4": "Closing square bracket, without an opening square bracket",
  "e5": "End of File encountered, unterminated array",
  "e6": "Closing curly brace, without an opening curly brace",
  "e7": "End of File encountered, unterminated javascript object '}'",
  "e8": "End of File encountered, unterminated parenthesis",
  "e9": "Invalid character in var name",
  "e10": "Extra chars at end of file. Maybe an extra ')'.",
  "e11": "Cannot Open include File",
  "e12": "Invalid no of arguments to ",
  "e13": "Invalid Argument type to ",
  "e14": "End of File encountered, unterminated regular expression",
  "e15": "Invalid vararg position, must be last argument.",
  "e16": "Invalid arity (args > expected) to ",
  "e17": "Invalid arity (args < expected) to "
};
function eval_QUERY_QUERY(x) {
  return ((Object.prototype.toString.call(x) === "[object Array]") ?
    evalList(x) :
    x);
}
function node_QUERY(obj) {
  return ((Object.prototype.toString.call(obj) === "[object Object]") && (true === obj["$$$isSourceNode$$$"]));
}
function error_BANG(e,line,file,msg) {
  throw new Error([ERRORS_MAP[e],(msg ?
    [" : ",msg].join("") :
    undefined),(line ?
    ["\nLine no ",line].join("") :
    undefined),(file ?
    ["\nFile ",file].join("") :
    undefined)].join(""));
}
function syntax_BANG(ecode,expr,cmd) {
  return error_BANG(ecode,(expr ?
    expr["line"] :
    undefined),(expr ?
    expr["source"] :
    undefined),cmd);
}
function assertArgs(expr,cnt,ecode,msg) {
  return (((expr)["length"] !== cnt) ?
    syntax_BANG(ecode,expr,msg) :
    undefined);
}
function pad(z) {
  return " ".repeat(z);
}
function toASTree(code,fname) {
  let state = {
    "codeStr": ["(",code,")"].join(""),
    "source": fname,
    "colno": 1,
    "line": 1,
    "pos": 1,
    "tcol": 1
  };
  return   (function(____self) {
  let ret = lexer(null,state);
  return   (function(____self) {
  ((state.pos < (state.codeStr)["length"]) ?
    error_BANG("e10") :
    undefined);
  return ret;
  })(this);
  })(this);
}
function parseTree(root) {
  let pstr = "",
    endx = ((root)["length"] - 1),
    treeSize = (root)["length"];
  indent += tabspace;
  pstr = pad(indent);
  return   (function(____self) {
  let ret = tnode();
  return   (function(____self) {
  nodeTag(ret,root["source"],root["line"],root["column"],tkn_tree);
  root.forEach(function (expr,i) {
    let name = get_QUERY_QUERY(nth(expr,0),"name",""),
      r = "",
      tmp = ((Object.prototype.toString.call(expr) === "[object Array]") ?
        evalList(expr) :
        expr);
    ((tmp && (tkn_tree === (tmp)["eTYPE"])) ?
            (function(____self) {
      ret.add(tmp);
      return tmp = null;
      })(this) :
      undefined);
    (((i === endx) && (0 !== indent) && (!REGEX.noret.test(name))) ?
      r = "return " :
      undefined);
    return (tmp ?
            (function(____self) {
      ret.add([
        [pstr,r].join(""),
        tmp,
        ((!noSemi_QUERY) ?
          ";" :
          ""),
        "\n"
      ]);
      return noSemi_QUERY = false;
      })(this) :
      undefined);
  });
  indent -= tabspace;
  return ret;
  })(this);
  })(this);
}
function evalList(expr) {
  let cmd = "",
    tmp = null,
    mc = null;
  ((tkn_object === (expr)["eTYPE"]) ?
    cmd = "{" :
    ((tkn_array === (expr)["eTYPE"]) ?
      cmd = "[" :
      (true ?
                (function(____self) {
        cmd = get_QUERY_QUERY(nth(expr,0),"name","");
        return mc = MACROS_MAP[cmd];
        })(this) :
        undefined)));
  return (some_QUERY(mc) ?
    eval_QUERY_QUERY(evalMacro(mc,expr)) :
    (cmd.startsWith(".-") ?
            (function(____self) {
      let ret = tnode();
      return       (function(____self) {
      ret.add(eval_QUERY_QUERY(nth(expr,1)));
      ret.prepend("(");
      ret.add([
        ")[\"",
        cmd.slice(2),
        "\"]"
      ]);
      return ret;
      })(this);
      })(this) :
      ((cmd.charAt(0) === ".") ?
                (function(____self) {
        let ret = tnode();
        return         (function(____self) {
        ret.add(eval_QUERY_QUERY(nth(expr,1)));
        ret.add([
          nth(expr,0),
          "("
        ]);
        (function (____self) {
for (var i = 2; (i < (expr)["length"]); i = (i + 1)) {
                    (function(____self) {
          ((i !== 2) ?
            ret.add(",") :
            undefined);
          return ret.add(eval_QUERY_QUERY(nth(expr,i)));
          })(this);
        }
})(this);
        ret.add(")");
        return ret;
        })(this);
        })(this) :
        (SPECIAL_OPS.hasOwnProperty(cmd) ?
          SPECIAL_OPS[cmd](expr) :
          (true ?
                        (function(____self) {
            evalAtoms(expr);
            cmd = nth(expr,0);
            ((!cmd) ?
              syntax_BANG("e1",expr) :
              undefined);
            (REGEX.func.test(cmd) ?
              cmd = tnodeEx([
                "(",
                cmd,
                ")"
              ]) :
              undefined);
            return tnodeEx([
              cmd,
              "(",
              tnodeEx(expr.slice(1)).join(","),
              ")"
            ]);
            })(this) :
            undefined)))));
}
function evalAtoms(cells) {
  return cells.forEach(function (cell,i,cc) {
    return ((Object.prototype.toString.call(cell) === "[object Array]") ?
      cc[i] = evalList(cell) :
      undefined);
  });
}
function expandMacro(cmd,code,data,frags) {
  let ret = nodeTag([],data.source,data.line,data.column,(code)["eTYPE"]),
    tmp = null,
    sname = get_QUERY_QUERY(nth(code,1),"name",""),
    ename = get_QUERY_QUERY(nth(code,0),"name",""),
    frag = frags[[TILDA,sname].join("")];
  return ((ename === "#<<") ?
    ((!(Object.prototype.toString.call(frag) === "[object Array]")) ?
      syntax_BANG("e13",data,cmd) :
      frag.shift()) :
    ((ename === "#head") ?
      ((!(Object.prototype.toString.call(frag) === "[object Array]")) ?
        syntax_BANG("e13",data,cmd) :
        (not_empty(frag) ?
          nth(frag,0) :
          undefined)) :
      ((ename === "#tail") ?
        ((!(Object.prototype.toString.call(frag) === "[object Array]")) ?
          syntax_BANG("e13",data,cmd) :
          (not_empty(frag) ?
            last(frag) :
            undefined)) :
        (ename.startsWith("#evens") ?
                    (function(____self) {
          let r = [];
          return           (function(____self) {
          (function (____self) {
for (var i = 0; (i < (frag)["length"]); i = (i + 2)) {
                        (function(____self) {
            return conj_BANG_BANG(r,nth(frag,i));
            })(this);
          }
})(this);
          (ename.endsWith("*") ?
            r["____split"] = true :
            undefined);
          return r;
          })(this);
          })(this) :
          (ename.startsWith("#odds") ?
                        (function(____self) {
            let r = [];
            return             (function(____self) {
            (function (____self) {
for (var i = 1; (i < (frag)["length"]); i = (i + 2)) {
                            (function(____self) {
              return conj_BANG_BANG(r,nth(frag,i));
              })(this);
            }
})(this);
            (ename.endsWith("*") ?
              r["____split"] = true :
              undefined);
            return r;
            })(this);
            })(this) :
            (ename.startsWith("#slice@") ?
                            (function(____self) {
              ((!(Object.prototype.toString.call(frag) === "[object Array]")) ?
                syntax_BANG("e13",data,cmd) :
                undefined);
              tmp = REGEX.macroGet.exec(ename);
              return nth(frag.splice((nth(tmp,1) - 1),1),0);
              })(this) :
              ((ename === "#if") ?
                                (function(____self) {
                ((!(Object.prototype.toString.call(frag) === "[object Array]")) ?
                  syntax_BANG("e13",data,cmd) :
                  undefined);
                return (not_empty(frag) ?
                  expandMacro(cmd,nth(code,2),data,frags) :
                  ((((code)["length"] > 3) && nth(code,3)) ?
                    expandMacro(cmd,nth(code,3),data,frags) :
                    undefined));
                })(this) :
                (true ?
                                    (function(____self) {
                  let cell = null;
                  (function (____self) {
for (var i = 0; (i < (code)["length"]); i = (i + 1)) {
                                        (function(____self) {
                    cell = nth(code,i);
                    return ((Object.prototype.toString.call(cell) === "[object Array]") ?
                                            (function(____self) {
                      let c = expandMacro(cmd,cell,data,frags);
                      return (((Object.prototype.toString.call(c) === "[object Array]") && (true === c["____split"])) ?
                        (function (____self) {
for (var k = 0; (k < (c)["length"]); k = (k + 1)) {
                                                    (function(____self) {
                          return conj_BANG_BANG(ret,nth(c,k));
                          })(this);
                        }
})(this) :
                        conj_BANG_BANG(ret,c));
                      })(this) :
                                            (function(____self) {
                      let atSign_QUERY = false,
                        rs = null,
                        tn = get_QUERY_QUERY(cell,"name","");
                      tmp = cell;
                      (tn.includes("@") ?
                                                (function(____self) {
                        rs = tn.replace("@","");
                        atSign_QUERY = true;
                        return tmp = tnode(cell.source,cell.line,cell.column,rs,rs);
                        })(this) :
                        undefined);
                      return                       (function(____self) {
                      let r = frags[get_QUERY_QUERY(tmp,"name","")];
                      return (some_QUERY(r) ?
                                                (function(____self) {
                        return ((atSign_QUERY || (get_QUERY_QUERY(tmp,"name","") === TILDA_VARGS)) ?
                          (function (____self) {
for (var j = 0; (j < (r)["length"]); j = (j + 1)) {
                                                        (function(____self) {
                            return conj_BANG_BANG(ret,nth(r,j));
                            })(this);
                          }
})(this) :
                          conj_BANG_BANG(ret,r));
                        })(this) :
                        conj_BANG_BANG(ret,cell));
                      })(this);
                      })(this));
                    })(this);
                  }
})(this);
                  return ret;
                  })(this) :
                  undefined))))))));
}
function evalMacro(mc,data) {
  let args = mc["args"],
    cmd = mc["name"],
    code = mc["code"],
    vargs = false,
    tpos = 0,
    i = 0,
    frags = {};
  (function (____self) {
for (var tpos = (i + 1); (i < (args)["length"]); i = (i + 1),tpos = (i + 1)) {
        (function(____self) {
    return ((get_QUERY_QUERY(nth(args,i),"name","") === VARGS) ?
            (function(____self) {
      vargs = true;
      return frags[TILDA_VARGS] = data.slice(tpos);
      })(this) :
      frags[[TILDA,get_QUERY_QUERY(nth(args,i),"name","")].join("")] = ((tpos >= (data)["length"]) ?
        tnodeEx("undefined") :
        nth(data,tpos)));
    })(this);
  }
})(this);
  (((!vargs) && ((i + 1) < (data)["length"])) ?
    syntax_BANG("e16",data,cmd) :
    undefined);
  return expandMacro(cmd,code,data,frags);
}
function sf_compOp(expr) {
  (((expr)["length"] < 3) ?
    syntax_BANG("e0",expr) :
    undefined);
  evalAtoms(expr);
    (function(____self) {
  let cmd = get_QUERY_QUERY(nth(expr,0),"name","");
  ((cmd === "!=") ?
    expr[0] = "!==" :
    undefined);
  return ((cmd === "=") ?
    expr[0] = "===" :
    undefined);
  })(this);
  return   (function(____self) {
  let ret = tnode();
  return   (function(____self) {
  (function (____self) {
for (var i = 0,op = expr.shift(); (i < ((expr)["length"] - 1)); i = (i + 1)) {
        (function(____self) {
    return ret.add(tnodeEx([
      nth(expr,i),
      " ",
      op,
      " ",
      nth(expr,(i + 1))
    ]));
    })(this);
  }
})(this);
  ret.join(" && ");
  ret.prepend("(");
  ret.add(")");
  return ret;
  })(this);
  })(this);
}
[
  "!=",
  "==",
  "=",
  ">",
  ">=",
  "<",
  "<="
].forEach(function (k) {
  return SPECIAL_OPS[k] = sf_compOp;
});
function sf_arithOp(expr) {
  (((expr)["length"] < 2) ?
    syntax_BANG("e0",expr) :
    undefined);
  evalAtoms(expr);
  let op = tnode(),
    e1 = expr.shift(),
    cmd = get_QUERY_QUERY(e1,"name","");
  return   (function(____self) {
  let ret = tnode();
  return   (function(____self) {
  ((1 === (expr)["length"]) ?
    (("-" === cmd) ?
      ret.add("-") :
      undefined) :
    op.add([
      " ",
      e1,
      " "
    ]));
  ret.add(expr);
  (((expr)["length"] > 1) ?
    ret.join(op) :
    undefined);
  ret.prepend("(");
  ret.add(")");
  return ret;
  })(this);
  })(this);
}
[
  "+",
  "-",
  "*",
  "/",
  "%"
].forEach(function (k) {
  return SPECIAL_OPS[k] = sf_arithOp;
});
function sf_logicalOp(expr) {
  return sf_arithOp(expr);
}
[
  "||",
  "&&",
  "^",
  "|",
  "&",
  ">>>",
  ">>",
  "<<"
].forEach(function (k) {
  return SPECIAL_OPS[k] = sf_logicalOp;
});
function sf_repeat(expr) {
  assertArgs(expr,3,"e0");
  evalAtoms(expr);
  return   (function(____self) {
  let ret = tnode();
  return   (function(____self) {
  (function (____self) {
for (var i = 0,end = parseInt(get_QUERY_QUERY(nth(expr,1),"name","")); (i < end); i = (i + 1)) {
        (function(____self) {
    ((i !== 0) ?
      ret.add(",") :
      undefined);
    return ret.add(nth(expr,2));
    })(this);
  }
})(this);
  ret.prepend("[");
  ret.add("]");
  return ret;
  })(this);
  })(this);
}
SPECIAL_OPS["repeat-n"] = sf_repeat;
function sf_do(expr) {
  let p = pad(indent),
    e = null,
    end = ((expr)["length"] - 1);
  return   (function(____self) {
  let ret = tnode();
  return   (function(____self) {
  (function (____self) {
for (var i = 1; (i < end); i = (i + 1)) {
        (function(____self) {
    e = nth(expr,i);
    return ret.add([
      p,
      evalList(e),
      ";\n"
    ]);
    })(this);
  }
})(this);
  ((end > 0) ?
        (function(____self) {
    e = eval_QUERY_QUERY(last(expr));
    ret.add([
      p,
      "return ",
      e,
      ";\n"
    ]);
    ret.prepend([p,"(function(____self) {\n"].join(""));
    return ret.add([p,"})(this)"].join(""));
    })(this) :
    undefined);
  return ret;
  })(this);
  })(this);
}
SPECIAL_OPS["do"] = sf_do;
function sf_doto(expr) {
  (((expr)["length"] < 2) ?
    syntax_BANG("e0",expr) :
    undefined);
  let p = pad(indent),
    p2 = pad((indent + tabspace)),
    p3 = pad((indent + (2 * tabspace))),
    e = null,
    e1 = eval_QUERY_QUERY(nth(expr,1));
  return   (function(____self) {
  let ret = tnode();
  return   (function(____self) {
  ret.add([
    p2,
    "let ____x = ",
    e1,
    ";\n"
  ]);
  (function (____self) {
for (var i = 2; (i < (expr)["length"]); i = (i + 1)) {
        (function(____self) {
    e = nth(expr,i);
    e.splice(1,0,"____x");
    return ret.add([
      p3,
      evalList(e),
      ";\n"
    ]);
    })(this);
  }
})(this);
  ret.add([
    p2,
    "return ____x;\n"
  ]);
  ret.prepend([p,"(function(____self) {\n"].join(""));
  ret.add([p,"})(this)"].join(""));
  return ret;
  })(this);
  })(this);
}
SPECIAL_OPS["doto"] = sf_doto;
function sf_case(expr) {
  (((expr)["length"] < 4) ?
    syntax_BANG("e0",expr) :
    undefined);
  let tst = nth(expr,1),
    e = null,
    t = null,
    c = null,
    dft = null;
  (odd_QUERY((expr)["length"]) ?
    dft = expr.pop() :
    undefined);
  return   (function(____self) {
  let ret = tnode();
  return   (function(____self) {
  (function (____self) {
for (var i = 2; (i < (expr)["length"]); i = (i + 2)) {
        (function(____self) {
    c = nth(expr,(i + 1));
    e = nth(expr,i);
    t = (e)["eTYPE"];
    return ((tkn_list === t) ?
      (function (____self) {
for (var j = 0; (j < (e)["length"]); j = (j + 1)) {
                (function(____self) {
        ret.add([
          "case ",
          nth(e,j),
          ":\n"
        ]);
        return ((j === ((e)["length"] - 1)) ?
          ret.add([
            eval_QUERY_QUERY(c),
            ";\nbreak;\n"
          ]) :
          undefined);
        })(this);
      }
})(this) :
      (true ?
                (function(____self) {
        ret.add([
          "case ",
          e,
          ":\n"
        ]);
        return ret.add([
          eval_QUERY_QUERY(c),
          ";\nbreak;\n"
        ]);
        })(this) :
        undefined));
    })(this);
  }
})(this);
  (dft ?
        (function(____self) {
    ret.add("default:\n");
    return ret.add([
      eval_QUERY_QUERY(dft),
      ";\nbreak;\n"
    ]);
    })(this) :
    undefined);
  ret.prepend([
    "switch (",
    eval_QUERY_QUERY(tst),
    ") {\n"
  ]);
  ret.add("}\n");
  ret.prepend("(function(____self) {\n");
  ret.add("})(this)");
  return ret;
  })(this);
  })(this);
}
SPECIAL_OPS["case"] = sf_case;
function sf_range(expr) {
  ((((expr)["length"] < 2) || ((expr)["length"] > 4)) ?
    syntax_BANG("e0",expr) :
    undefined);
  let len = 0,
    start = 0,
    step = 1,
    end = 0;
  evalAtoms(expr);
  len = (expr)["length"];
  end = parseInt(get_QUERY_QUERY(nth(expr,1),"name",""));
  return   (function(____self) {
  let ret = tnode();
  return   (function(____self) {
  ((len > 2) ?
        (function(____self) {
    start = parseInt(get_QUERY_QUERY(nth(expr,1),"name",""));
    return end = parseInt(get_QUERY_QUERY(nth(expr,2),"name",""));
    })(this) :
    undefined);
  ((len > 3) ?
    step = parseInt(get_QUERY_QUERY(nth(expr,3),"name","")) :
    undefined);
  (function (____self) {
for (var i = start; (i < end); i = (i + step)) {
        (function(____self) {
    ((i !== start) ?
      ret.add(",") :
      undefined);
    return ret.add(["",i].join(""));
    })(this);
  }
})(this);
  ret.prepend("[");
  ret.add("]");
  return ret;
  })(this);
  })(this);
}
SPECIAL_OPS["range"] = sf_range;
function sf_var(expr,cmd) {
  ((((expr)["length"] < 3) || (0 === ((expr)["length"] % 2))) ?
    syntax_BANG("e0",expr) :
    undefined);
  let vname = null,
    public_QUERY = ("global" === cmd);
  (((expr)["length"] > 3) ?
    indent += tabspace :
    undefined);
  ((public_QUERY || ("local" === cmd)) ?
    cmd = "var" :
    undefined);
  evalAtoms(expr);
  return   (function(____self) {
  let ret = tnode();
  return   (function(____self) {
  (function (____self) {
for (var i = 1; (i < (expr)["length"]); i = (i + 2)) {
        (function(____self) {
    ((i > 1) ?
      ret.add([",\n",pad(indent)].join("")) :
      undefined);
    ((!testid_QUERY(nth(expr,i))) ?
      syntax_BANG("e9",expr) :
      undefined);
    vname = nth(expr,i);
    ((public_QUERY && (1 === (_STARnspaces_STAR)["length"])) ?
      _STARexterns_STAR[vname] = vname :
      undefined);
    return ret.add([
      vname,
      " = ",
      nth(expr,(i + 1))
    ]);
    })(this);
  }
})(this);
  ret.prepend(" ");
  ret.prepend(cmd);
  (((expr)["length"] > 3) ?
    indent -= tabspace :
    undefined);
  return ret;
  })(this);
  })(this);
}
SPECIAL_OPS["def-"] = function (x) {
  return sf_var(x,"local");
};
SPECIAL_OPS["def"] = function (x) {
  return sf_var(x,"global");
};
SPECIAL_OPS["var"] = function (x) {
  return sf_var(x,"let");
};
function sf_new(expr) {
  (((expr)["length"] < 2) ?
    syntax_BANG("e0",expr) :
    undefined);
  return   (function(____self) {
  let ret = tnode();
  return   (function(____self) {
  ret.add(evalList(expr.slice(1)));
  ret.prepend("new ");
  return ret;
  })(this);
  })(this);
}
SPECIAL_OPS["new"] = sf_new;
function sf_throw(expr) {
  assertArgs(expr,2,"e0");
  return   (function(____self) {
  let ret = tnode();
  return   (function(____self) {
  ret.add(eval_QUERY_QUERY(nth(expr,1)));
  ret.prepend("throw ");
  return ret;
  })(this);
  })(this);
}
SPECIAL_OPS["throw"] = sf_throw;
function sf_while(expr) {
  (((expr)["length"] < 2) ?
    syntax_BANG("e0",expr) :
    undefined);
  let tst = nth(expr,1);
  expr.splice(0,2,tnodeEx("do","do"));
  return   (function(____self) {
  let ret = null;
  return   (function(____self) {
  ret = tnodeEx([
    "while ",
    eval_QUERY_QUERY(tst),
    " {\n",
    evalList(expr),
    ";\n}\n"
  ]);
  ret.prepend(["(function (____self) {\n"].join(""));
  ret.add("})(this)");
  return ret;
  })(this);
  })(this);
}
SPECIAL_OPS["while"] = sf_while;
function sf_x_opop(expr,op) {
  (((expr)["length"] !== 2) ?
    syntax_BANG("e0",expr) :
    undefined);
  return tnodeEx([
    op,
    eval_QUERY_QUERY(nth(expr,1))
  ]);
}
SPECIAL_OPS["dec!!"] = function (x) {
  return sf_x_opop(x,"--");
};
SPECIAL_OPS["inc!!"] = function (x) {
  return sf_x_opop(x,"++");
};
function sf_x_eq(expr,op) {
  assertArgs(expr,3,"e0");
  return tnodeEx([
    nth(expr,1),
    [" ",op,"= "].join(""),
    eval_QUERY_QUERY(nth(expr,2))
  ]);
}
SPECIAL_OPS["dec!"] = function (x) {
  return sf_x_eq(x,"-");
};
SPECIAL_OPS["inc!"] = function (x) {
  return sf_x_eq(x,"+");
};
function sf_set(expr) {
  ((!(((expr)["length"] === 3) || ((expr)["length"] === 4))) ?
    syntax_BANG("e0",expr) :
    undefined);
  return   (function(____self) {
  let ret = tnode();
  return   (function(____self) {
  (((expr)["length"] === 4) ?
        (function(____self) {
    ret.add(eval_QUERY_QUERY(nth(expr,1)));
    ret.add("[");
    ret.add(eval_QUERY_QUERY(nth(expr,2)));
    return ret.add("]");
    })(this) :
    ret.add(nth(expr,1)));
  ret.add([
    " = ",
    eval_QUERY_QUERY(last(expr))
  ]);
  return ret;
  })(this);
  })(this);
}
SPECIAL_OPS["aset"] = sf_set;
SPECIAL_OPS["set!"] = sf_set;
function sf_anonFunc(expr) {
  (((expr)["length"] < 2) ?
    syntax_BANG("e0",expr) :
    undefined);
  ((!(Object.prototype.toString.call(nth(expr,1)) === "[object Array]")) ?
    syntax_BANG("e0",expr) :
    undefined);
  let args = nth(expr,1),
    body = expr.slice(2);
  return   (function(____self) {
  let ret = tnodeEx(args);
  return   (function(____self) {
  ret.join(",");
  ret.prepend("function (");
  ret.add([
    ") {\n",
    parseTree(body),
    pad(indent),
    "}"
  ]);
  return ret;
  })(this);
  })(this);
}
SPECIAL_OPS["fn"] = sf_anonFunc;
function sf_func(expr,public_QUERY) {
  (((expr)["length"] < 3) ?
    syntax_BANG("e0",expr) :
    undefined);
  let fname = normalizeId(get_QUERY_QUERY(nth(expr,1),"name","")),
    doc = null,
    args = 2,
    body = 3;
  ((tkn_string === nth(expr,2)["eTYPE"]) ?
        (function(____self) {
    doc = 2;
    args = 3;
    return body = 4;
    })(this) :
    undefined);
  (doc ?
    doc = nth(expr,doc) :
    undefined);
  args = nth(expr,args);
  body = expr.slice(body);
  return   (function(____self) {
  let ret = null;
  return   (function(____self) {
  ret = tnodeEx(args);
  ret.join(",");
  ret.prepend(["function ",fname,"("].join(""));
  ret.add([
    ") {\n",
    parseTree(body),
    pad(indent),
    "}"
  ]);
  (doc ?
        (function(____self) {
    return ret.prepend(get_QUERY_QUERY(doc,"name","").replace(REGEX.dquoteHat,"").replace(REGEX.dquoteEnd,"").split("\\n").map(function (x) {
      return ["//",x,"\n"].join("");
    }));
    })(this) :
    undefined);
  ((public_QUERY && (1 === (_STARnspaces_STAR)["length"])) ?
    _STARexterns_STAR[fname] = fname :
    undefined);
  noSemi_QUERY = true;
  return ret;
  })(this);
  })(this);
}
SPECIAL_OPS["defn-"] = function (x) {
  return sf_func(x,false);
};
SPECIAL_OPS["defn"] = function (x) {
  return sf_func(x,true);
};
function sf_try(expr) {
  let sz = (expr)["length"],
    t = null,
    f = null,
    c = null,
    ind = pad(indent);
  f = last(expr);
  (((Object.prototype.toString.call(f) === "[object Array]") && (get_QUERY_QUERY(nth(f,0),"name","") === "finally")) ?
        (function(____self) {
    f = expr.pop();
    return sz = (expr)["length"];
    })(this) :
    f = null);
  c = ((sz > 1) ?
    nth(expr,(sz - 1)) :
    null);
  (((Object.prototype.toString.call(c) === "[object Array]") && (get_QUERY_QUERY(nth(c,0),"name","") === "catch")) ?
        (function(____self) {
    ((((c)["length"] < 2) || (!node_QUERY(nth(c,1)))) ?
      syntax_BANG("e0",expr) :
      undefined);
    return c = expr.pop();
    })(this) :
    c = null);
  (((Object.prototype.toString.call(f) === "[object Null]") && (Object.prototype.toString.call(c) === "[object Null]")) ?
    syntax_BANG("e0",expr) :
    undefined);
  return   (function(____self) {
  let ret = tnodeEx([
    ["(function(____self) {\n",ind,"try {\n"].join(""),
    parseTree(expr.slice(1)),
    ["\n",ind,"} "].join("")
  ]);
  return   (function(____self) {
  (c ?
        (function(____self) {
    t = nth(c,1);
    c.splice(0,2,tnodeEx("do","do"));
    return ret.add([
      ["catch (",t,") {\n"].join(""),
      "return ",
      evalList(c),
      [";\n",ind,"}\n"].join("")
    ]);
    })(this) :
    undefined);
  (f ?
        (function(____self) {
    f.splice(0,1,tnodeEx("do","do"));
    return ret.add([
      "finally {\n",
      evalList(f),
      [";\n",ind,"}\n"].join("")
    ]);
    })(this) :
    undefined);
  ret.add([ind,"})(this)"].join(""));
  return ret;
  })(this);
  })(this);
}
SPECIAL_OPS["try"] = sf_try;
function sf_if(expr) {
  ((((expr)["length"] < 3) || ((expr)["length"] > 4)) ?
    syntax_BANG("e0",expr) :
    undefined);
  indent += tabspace;
  evalAtoms(expr);
  return (function(____self) {
  try {
    return tnodeEx([
      "(",
      nth(expr,1),
      [" ?\n",pad(indent)].join(""),
      nth(expr,2),
      [" :\n",pad(indent)].join(""),
      (nth(expr,3) || "undefined"),
      ")"
    ]);

  } finally {
  (function(____self) {
  return indent -= tabspace;
  })(this);
  }
  })(this);
}
SPECIAL_OPS["if"] = sf_if;
function sf_get(expr) {
  assertArgs(expr,3,"e0");
  evalAtoms(expr);
  return tnodeEx([
    nth(expr,1),
    "[",
    nth(expr,2),
    "]"
  ]);
}
SPECIAL_OPS["get"] = sf_get;
SPECIAL_OPS["aget"] = SPECIAL_OPS["get"];
function sf_str(expr) {
  (((expr)["length"] < 2) ?
    syntax_BANG("e0",expr) :
    undefined);
  evalAtoms(expr);
  return   (function(____self) {
  let ret = tnode();
  return   (function(____self) {
  ret.add(expr.slice(1));
  ret.join(",");
  ret.prepend("[");
  ret.add("].join(\"\")");
  return ret;
  })(this);
  })(this);
}
SPECIAL_OPS["str"] = sf_str;
function sf_array(expr) {
  let p = pad(indent),
    epilog = ["\n",p,"]"].join("");
  return   (function(____self) {
  let ret = tnode();
  return   (function(____self) {
  (empty_QUERY(expr) ?
    ret.add("[]") :
    (function(____self) {
    try {
      ((tkn_array !== (expr)["eTYPE"]) ?
        expr.splice(0,1) :
        undefined);
      indent += tabspace;
      evalAtoms(expr);
      p = pad(indent);
      ret.add(["[\n",p].join(""));
      (function (____self) {
for (var i = 0; (i < (expr)["length"]); i = (i + 1)) {
                (function(____self) {
        ((i > 0) ?
          ret.add([",\n",p].join("")) :
          undefined);
        return ret.add(nth(expr,i));
        })(this);
      }
})(this);
      return ret.add(epilog);

    } finally {
    (function(____self) {
    return indent -= tabspace;
    })(this);
    }
    })(this));
  return ret;
  })(this);
  })(this);
}
SPECIAL_OPS["["] = sf_array;
SPECIAL_OPS["vec"] = SPECIAL_OPS["["];
function sf_object(expr) {
  let p = pad(indent),
    epilog = ["\n",p,"}"].join("");
  return   (function(____self) {
  let ret = tnode();
  return   (function(____self) {
  (empty_QUERY(expr) ?
    ret.add("{}") :
    (function(____self) {
    try {
      ((tkn_object !== (expr)["eTYPE"]) ?
        expr.splice(0,1) :
        undefined);
      indent += tabspace;
      evalAtoms(expr);
      p = pad(indent);
      ret.add(["{\n",p].join(""));
      (function (____self) {
for (var i = 0; (i < (expr)["length"]); i = (i + 2)) {
                (function(____self) {
        ((i > 0) ?
          ret.add([",\n",p].join("")) :
          undefined);
        return ret.add([
          nth(expr,i),
          ": ",
          nth(expr,(i + 1))
        ]);
        })(this);
      }
})(this);
      return ret.add(epilog);

    } finally {
    (function(____self) {
    return indent -= tabspace;
    })(this);
    }
    })(this));
  return ret;
  })(this);
  })(this);
}
SPECIAL_OPS["{"] = sf_object;
SPECIAL_OPS["hash-map"] = SPECIAL_OPS["{"];
var includeFile = (function () {
  let icache = [];
  return function (fname) {
    return (contains_QUERY(icache,fname) ?
      "" :
            (function(____self) {
      icache.push(fname);
      return parseTree(toASTree(_STARfs_STAR.readFileSync(fname),fname));
      })(this));
  };
})();
function sf_include(expr) {
  assertArgs(expr,2,"e0");
  let dir = _STARpath_STAR.dirname((expr)["source"]),
    found = false,
    fname = get_QUERY_QUERY(nth(expr,1),"name","");
  ((typeof(fname) === "string") ?
    fname = fname.replace(new RegExp("[\"]","g"),"") :
    undefined);
  (function(____self) {
  try {
    return fname = _STARfs_STAR.realpathSync([dir,"/",fname].join(""));

  } catch (e) {
return   (function(____self) {
  return syntax_BANG("e11",expr);
  })(this);
  }
  })(this);
  return (function(____self) {
  try {
    indent -= tabspace;
    return includeFile(fname);

  } finally {
  (function(____self) {
  _STARnspaces_STAR.pop();
  return indent += tabspace;
  })(this);
  }
  })(this);
}
SPECIAL_OPS["include"] = sf_include;
function sf_ns(expr) {
  (((expr)["length"] < 2) ?
    syntax_BANG("e0",expr) :
    undefined);
  return   (function(____self) {
  let ret = tnode();
  return   (function(____self) {
  (function (____self) {
for (var i = 1; (i < (expr)["length"]); i = (i + 1)) {
        (function(____self) {
    let e = nth(expr,i),
      t = (e)["eTYPE"];
    return ((tkn_ident === t) ?
      _STARnspaces_STAR.push(e) :
      ((tkn_list === t) ?
        (("include" === get_QUERY_QUERY(nth(e,0),"name","")) ?
          ret = sf_include(e) :
          undefined) :
        undefined));
    })(this);
  }
})(this);
  return ret;
  })(this);
  })(this);
}
SPECIAL_OPS["ns"] = sf_ns;
function sf_comment(expr) {
  return "";
}
SPECIAL_OPS["comment"] = sf_comment;
function sf_floop(expr) {
  (((expr)["length"] < 2) ?
    syntax_BANG("e0",expr) :
    undefined);
  let c1 = null,
    c2 = null,
    c3 = null,
    c = nth(expr,1),
    ind = pad(indent);
  return   (function(____self) {
  let ret = tnodeEx("for (");
  return   (function(____self) {
  (((!(Object.prototype.toString.call(c) === "[object Array]")) || ((c)["length"] !== 3)) ?
    syntax_BANG("e0",expr) :
    undefined);
  c1 = nth(c,0);
  c2 = nth(c,1);
  c3 = nth(c,2);
  indent += tabspace;
  (function (____self) {
for (var i = 0; (i < (c1)["length"]); i = (i + 2)) {
        (function(____self) {
    (zero_QUERY(i) ?
      ret.add("var ") :
      undefined);
    ((i > 0) ?
      ret.add(",") :
      undefined);
    return ret.add([
      nth(c1,i),
      " = ",
      eval_QUERY_QUERY(nth(c1,(i + 1)))
    ]);
    })(this);
  }
})(this);
  ret.add("; ");
  ret.add(evalList(c2));
  ret.add("; ");
  (function (____self) {
for (var i = 0; (i < (c3)["length"]); i = (i + 2)) {
        (function(____self) {
    ((i > 0) ?
      ret.add(",") :
      undefined);
    return ret.add([
      nth(c3,i),
      " = ",
      eval_QUERY_QUERY(nth(c3,(i + 1)))
    ]);
    })(this);
  }
})(this);
  ret.add(") {\n");
  (((expr)["length"] > 2) ?
        (function(____self) {
    expr.splice(0,2,tnodeEx("do","do"));
    return ret.add([
      ind,
      pad(tabspace),
      evalList(expr),
      ";"
    ]);
    })(this) :
    undefined);
  ret.add(["\n",ind,"}\n"].join(""));
  ret.prepend("(function (____self) {\n");
  ret.add("})(this)");
  indent -= tabspace;
  return ret;
  })(this);
  })(this);
}
SPECIAL_OPS["for"] = sf_floop;
function sf_jscode(expr) {
  assertArgs(expr,2,"e0");
  noSemi_QUERY = true;
  nth(expr,1).replaceRight(new RegExp("\"","g"),"");
  return nth(expr,1);
}
SPECIAL_OPS["js#"] = sf_jscode;
function sf_macro(expr) {
  (((expr)["length"] < 4) ?
    syntax_BANG("e0",expr) :
    undefined);
  let a3 = nth(expr,3),
    a2 = nth(expr,2),
    doc = null,
    cmd = get_QUERY_QUERY(nth(expr,1),"name","");
  ((tkn_string === a2["eTYPE"]) ?
        (function(____self) {
    doc = nth(expr,2);
    a2 = nth(expr,3);
    return a3 = nth(expr,4);
    })(this) :
    undefined);
  return   (function(____self) {
  let ret = "";
  return   (function(____self) {
  (function (____self) {
for (var i = 0; (i < (a2)["length"]); i = (i + 1)) {
        (function(____self) {
    return (((get_QUERY_QUERY(nth(a2,i),"name","") === VARGS) && ((i + 1) !== (a2)["length"])) ?
      syntax_BANG("e15",expr,cmd) :
      undefined);
    })(this);
  }
})(this);
  MACROS_MAP[cmd] = {
    "doc": doc,
    "args": a2,
    "code": a3,
    "name": cmd
  };
  return ret;
  })(this);
  })(this);
}
SPECIAL_OPS["defmacro"] = sf_macro;
function sf_not(expr) {
  assertArgs(expr,2,"e0");
  evalAtoms(expr);
  return ["(!",nth(expr,1),")"].join("");
}
SPECIAL_OPS["!"] = sf_not;
function dbg(obj,hint) {
  return ((Object.prototype.toString.call(obj) === "[object Array]") ?
        (function(____self) {
    hint = (hint || "block");
    console.log(["<",hint,">"].join(""));
    (function (____self) {
for (var i = 0; (i < (obj)["length"]); i = (i + 1)) {
            (function(____self) {
      return dbg(nth(obj,i));
      })(this);
    }
})(this);
    return console.log(["</",hint,">"].join(""));
    })(this) :
    (node_QUERY(obj) ?
            (function(____self) {
      console.log("<node>");
      console.log(obj);
      dbg(obj.children,"subs");
      return console.log("</node>");
      })(this) :
      (true ?
        console.log(obj) :
        undefined)));
}
function spitExterns() {
  let p = pad(tabspace),
    s = Object.keys(_STARexterns_STAR).map(function (k) {
      return [p,k,": ",k].join("");
    }).join(",\n");
  return ["\n\nmodule.exports = {\n",s,"\n};\n\n"].join("");
}
function compileCode(codeStr,fname,withSrcMap_QUERY) {
  ((!loadedMacros_QUERY) ?
        (function(____self) {
    loadedMacros_QUERY = true;
    return require("./macros.kirby");
    })(this) :
    undefined);
  indent = (-tabspace);
  _STARexterns_STAR = {};
  _STARnspaces_STAR = [];
  let outNode = parseTree(toASTree(codeStr,fname)),
    extra = spitExterns();
  outNode.prepend(banner());
  return (withSrcMap_QUERY ?
        (function(____self) {
    let outFile = [_STARpath_STAR.basename(fname,".kirby"),".js"].join(""),
      srcMap = [outFile,".map"].join(""),
      output = outNode.toStringWithSourceMap({
        "file": outFile
      });
    fs.writeFileSync(srcMap,output.map);
    return [output.code,extra,"\n//# sourceMappingURL=",_STARpath_STAR.relative(_STARpath_STAR.dirname(fname),srcMap)].join("");
    })(this) :
    [outNode,extra].join(""));
}
function transpileXXX(code,file,smap_QUERY) {
  return (function(____self) {
  try {
    return compileCode(code,file,smap_QUERY);

  } catch (e) {
return   (function(____self) {
  console.log(e.stack);;
  throw e;
  return null;
  })(this);
  }
  })(this)
}
function dbgAST(codeStr,fname) {
  return dbg(toASTree(codeStr,fname),"tree");
}
function transpileWithSrcMap(code,file) {
  return transpileXXX(code,file,true);
}
function transpile(code,file) {
  return transpileXXX(code,file,false);
}
function parseWithSourceMap(codeStr,fname) {
  let outNode = parseTree(toASTree(codeStr,fname));
  outNode.prepend(MODULE_BANNER);
  return outNode.toStringWithSourceMap();
}
var version = MODULE_VERSION;


module.exports = {
  dbgAST: dbgAST,
  transpileWithSrcMap: transpileWithSrcMap,
  transpile: transpile,
  parseWithSourceMap: parseWithSourceMap,
  version: version
};

