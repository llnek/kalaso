// Generated by LispyScript v1.5.0
var _STARpath_STAR = require("path"),
  _STARfs_STAR = require("fs");
var _STARprocess_STAR = process;
require.extensions[".kirby"] = function (module,fname) {
  let kb = require("kirby"),
    code = _STARfs_STAR.readFileSync(fname,"utf8");
  return module._compile(kb.transpile(code,_STARpath_STAR.relative(_STARprocess_STAR.cwd(),fname)),fname);
};
function some_QUERY(obj) {
  return (!((typeof(obj) === "undefined") || (Object.prototype.toString.call(obj) === "[object Null]")));
}
function zero_QUERY(obj) {
  return ((Object.prototype.toString.call(obj) === "[object Number]") ?
    (0 == obj) :
    false);
}
function make_array(len,obj) {
  return   (function() {
  let ret = [];
  return   (function() {
  (function () {
for (var i = 0; (i < len); i = (i + 1)) {
        (function() {
    return ret.push(obj);
    })();
  }
})();
  return ret;
  })();
  })();
}
function each_key(func,obj) {
  return Object.keys(obj).forEach(function (k) {
    return func(obj[k],k,obj);
  });
}
function last(coll) {
  return coll[((coll)["length"] - 1)];
}
function nth(coll,pos) {
  return coll[pos];
}
function pos_QUERY(arg) {
  return ((Object.prototype.toString.call(arg) === "[object Number]") && (arg > 0));
}
function neg_QUERY(arg) {
  return ((Object.prototype.toString.call(arg) === "[object Number]") && (arg < 0));
}
function constantly(x) {
  return function () {
    return x;
  };
}
function identity(x) {
  return x;
}
function repeat(n,expr) {
  return [];
}
function conj_BANG(c,a) {
  c.push(a);
  return c;
}
function conj_BANG_BANG(c,a) {
  (a ?
    c.push(a) :
    undefined);
  return c;
}
function not_empty(x) {
  return ((x && ((x)["length"] > 0)) ?
    x :
    null);
}
function empty_QUERY(x) {
  return (x ?
    (0 == (x)["length"]) :
    false);
}
function seq(x) {
  return ((Object.prototype.toString.call(x) === "[object String]") ?
    Array.from(x) :
    ((Object.prototype.toString.call(x) === "[object Array]") ?
      x :
      ((Object.prototype.toString.call(x) === "[object Object]") ?
        Object.entries(x) :
        (true ?
          [] :
          undefined))));
}
var TreeNode = (require("source-map"))["SourceNode"];
var _STARfs_STAR = null,
  _STARpath_STAR = null;
var REGEX = {
  macroGet: new RegExp("^#slice@(\\d+)"),
  noret: new RegExp("^def\\b|^var\\b|^set!\\b|^throw\\b"),
  id: new RegExp("^[a-zA-Z_$][?\\-*!0-9a-zA-Z_$]*$"),
  id2: new RegExp("^[*\\-][?\\-*!0-9a-zA-Z_$]+$"),
  func: new RegExp("^function\\b"),
  query: new RegExp("\\?","g"),
  bang: new RegExp("!","g"),
  dash: new RegExp("-","g"),
  star: new RegExp("\\*","g"),
  wspace: new RegExp("\\s")
};
var KIRBY = "____kirby";
((typeof(window) === "undefined") ?
    (function() {
  _STARpath_STAR = require("path");
  return _STARfs_STAR = require("fs");
  })() :
  undefined);
function testid_QUERY(name) {
  return (REGEX.id.test(name) || REGEX.id2.test(name));
}
function normalizeId(name) {
  let pfx = "";
  (((Object.prototype.toString.call(name) === "[object String]") && ("-" === name.charAt(0))) ?
        (function() {
    pfx = "-";
    return name = name.slice(1);
    })() :
    undefined);
  return (testid_QUERY(name) ?
    [pfx,name].join("").replace(REGEX.query,"_QUERY").replace(REGEX.bang,"_BANG").replace(REGEX.dash,"_").replace(REGEX.star,"_STAR") :
    ((pfx === "") ?
      name :
      [pfx,name].join("")));
}
function tnodeString() {
  let me = this;
  return   (function() {
  let s = "";
  return   (function() {
  me.walk(function (chunk,hint) {
    (((hint.name === chunk) && (Object.prototype.toString.call(chunk) === "[object String]")) ?
      chunk = normalizeId(chunk) :
      undefined);
    return s += chunk;
  });
  return s;
  })();
  })();
}
function tnode(ln,col,src,chunk,name) {
  let args_QUERY = ((arguments)["length"] > 0);
  return   (function() {
  let n = null;
  return   (function() {
  (args_QUERY ?
    n = (name ?
      new TreeNode(ln,col,src,chunk,name) :
      new TreeNode(ln,col,src,chunk)) :
    n = new TreeNode());
  n[KIRBY] = {
    eTYPE: null
  };
  n["toString"] = tnodeString;
  return n;
  })();
  })();
}
function tnodeChunk(chunk,name) {
  return tnode(null,null,null,chunk,name);
}
function addToken(tree,token,context) {
  return   (function() {
  let ret = "";
  return   (function() {
  (token ?
        (function() {
    ((":else" === token) ?
      token = "true" :
      undefined);
    (("nil" === token) ?
      token = "null" :
      undefined);
    (((token.startsWith(":") || token.startsWith("'")) && testid_QUERY(token.substring(1))) ?
      token = ["\"",token.substring(1),"\""].join("") :
      undefined);
    return conj_BANG_BANG(tree,tnode(context.lineno,(context.tknCol - 1),context.filename,token,token));
    })() :
    undefined);
  return ret;
  })();
  })();
}
function lexer(prevToken,context) {
  let ____BREAK_BANG = null,
    formType = null,
    state = null,
    token = "",
    ch = null,
    escStr_QUERY = false,
    inStr_QUERY = false,
    comment_QUERY = false;
  return   (function() {
  let tree = [];
  return   (function() {
  state = [
    "filename",
    "lineno"
  ].reduce(function (acc,k) {
    acc[k] = context[k];
    return acc;
  },{});
  tree[KIRBY] = state;
  (("[" === prevToken) ?
    state["eTYPE"] = "array" :
    (("{" === prevToken) ?
      state["eTYPE"] = "object" :
      undefined));
  ____BREAK_BANG = false;
  (function () {
while ((!____BREAK_BANG) && (context.pos < (context.codeStr)["length"])) {
  (function() {
  ch = context.codeStr.charAt(context.pos);
  ++context.colno;
  ++context.pos;
  ((ch === "\n") ?
        (function() {
    ++context.lineno;
    context.colno = 1;
    return (comment_QUERY ?
      comment_QUERY = (!comment_QUERY) :
      undefined);
    })() :
    undefined);
  return (comment_QUERY ?
    null :
    (escStr_QUERY ?
            (function() {
      escStr_QUERY = (!escStr_QUERY);
      return token += ch;
      })() :
      ((ch === "\"") ?
                (function() {
        inStr_QUERY = (!inStr_QUERY);
        return token += ch;
        })() :
        (inStr_QUERY ?
                    (function() {
          ((ch === "\n") ?
            ch = "\\n" :
            undefined);
          ((ch === "\\") ?
            escStr_QUERY = true :
            undefined);
          return token += ch;
          })() :
          ((ch === "'") ?
            token += ch :
            (((ch === "[") || (ch === "]")) ?
                            (function() {
              token = addToken(tree,token,context);
              context.tknCol = context.colno;
              return ((ch === "[") ?
                                (function() {
                formType = "array";
                return conj_BANG_BANG(tree,lexer(ch,context));
                })() :
                                (function() {
                formType = null;
                return ____BREAK_BANG = true;
                })());
              })() :
              (((ch === "{") || (ch === "}")) ?
                                (function() {
                token = addToken(tree,token,context);
                context.tknCol = context.colno;
                return ((ch === "{") ?
                                    (function() {
                  formType = "object";
                  return conj_BANG_BANG(tree,lexer(ch,context));
                  })() :
                                    (function() {
                  formType = null;
                  return ____BREAK_BANG = true;
                  })());
                })() :
                ((ch === ";") ?
                  comment_QUERY = true :
                  (((ch === "(") || (ch === ")")) ?
                                        (function() {
                    token = addToken(tree,token,context);
                    context.tknCol = context.colno;
                    return ((ch === "(") ?
                                            (function() {
                      formType = "list";
                      return conj_BANG_BANG(tree,lexer(null,context));
                      })() :
                                            (function() {
                      formType = null;
                      return ____BREAK_BANG = true;
                      })());
                    })() :
                    (REGEX.wspace.test(ch) ?
                                            (function() {
                      ((ch === "\n") ?
                        --context.lineno :
                        undefined);
                      token = addToken(tree,token,context);
                      ((ch === "\n") ?
                        ++context.lineno :
                        undefined);
                      return context.tknCol = context.colno;
                      })() :
                      (true ?
                        token += ch :
                        undefined)))))))))));
  })();
}
})();
  (inStr_QUERY ?
    syntax_BANG("e3",tree) :
    undefined);
  ((formType === "array") ?
    syntax_BANG("e5",tree) :
    ((formType === "object") ?
      syntax_BANG("e7",tree) :
      ((formType === "list") ?
        syntax_BANG("e8",tree) :
        undefined)));
  return tree;
  })();
  })();
}
var MODULE_BANNER = "/* Kirby Generated: Test only */\n",
  MODULE_VERSION = "1.0.0",
  loadedMacros_QUERY = false,
  includePaths = [],
  noSemi_QUERY = false,
  tabspace = 2,
  VARGS = "&rest",
  TILDA = "~",
  indent = (-tabspace),
  TILDA_VARGS = [TILDA,VARGS].join("");
var SPECIAL_OPS = {};
var MACROS_MAP = {};
var ERRORS_MAP = {
  e0: "Syntax Error",
  e1: "Empty statement",
  e2: "Invalid characters in function name",
  e3: "End of File encountered, unterminated string",
  e4: "Closing square bracket, without an opening square bracket",
  e5: "End of File encountered, unterminated array",
  e6: "Closing curly brace, without an opening curly brace",
  e7: "End of File encountered, unterminated javascript object '}'",
  e8: "End of File encountered, unterminated parenthesis",
  e9: "Invalid character in var name",
  e10: "Extra chars at end of file. Maybe an extra ')'.",
  e11: "Cannot Open include File",
  e12: "Invalid no of arguments to ",
  e13: "Invalid Argument type to ",
  e14: "End of File encountered, unterminated regular expression",
  e15: "Invalid vararg position, must be last argument.",
  e16: "Invalid arity (args > expected) to ",
  e17: "Invalid arity (args < expected) to "
};
function eval_QUERY_QUERY(x) {
  return ((Object.prototype.toString.call(x) === "[object Array]") ?
    evalList(x) :
    x);
}
function node_QUERY(obj) {
  return ((Object.prototype.toString.call(obj) === "[object Object]") && (true === obj["$$$isSourceNode$$$"]));
}
function error_BANG(e,line,file,msg) {
  throw new Error([ERRORS_MAP[e],(msg ?
    [" : ",msg].join("") :
    undefined),(line ?
    ["\nLine no ",line].join("") :
    undefined),(file ?
    ["\nFile ",file].join("") :
    undefined)].join(""));;
}
function syntax_BANG(ecode,expr,cmd) {
  let info = (expr[KIRBY] || {});
  return error_BANG(ecode,info.filename,info.lineno,cmd);
}
function assertArgs(expr,cnt,ecode,msg) {
  return (((expr)["length"] !== cnt) ?
    syntax_BANG(ecode,expr,msg) :
    undefined);
}
function pad(z) {
  return " ".repeat(z);
}
function toASTree(code,fname) {
  let state = {
    codeStr: ["(",code,")"].join(""),
    filename: fname,
    lineno: 1,
    colno: 1,
    pos: 1,
    tknCol: 1
  };
  return   (function() {
  let ret = lexer(null,state);
  return   (function() {
  ((state.pos < (state.codeStr)["length"]) ?
    error_BANG("e10") :
    undefined);
  return ret;
  })();
  })();
}
function parseTree(root) {
  let pstr = "",
    endx = ((root)["length"] - 1),
    treeSize = (root)["length"];
  indent += tabspace;
  pstr = pad(indent);
  return   (function() {
  let ret = tnode();
  return   (function() {
  root.forEach(function (expr,i) {
    let name = "",
      tmp = null,
      r = "";
    ((Object.prototype.toString.call(expr) === "[object Array]") ?
            (function() {
      let e = expr[0];
      (node_QUERY(e) ?
        name = e.name :
        undefined);
      tmp = evalList(expr);
      return ((name === "include") ?
                (function() {
        ret.add(tmp);
        return tmp = null;
        })() :
        undefined);
      })() :
      tmp = expr);
    (((i === endx) && (0 !== indent) && (!REGEX.noret.test(name))) ?
      r = "return " :
      undefined);
    return (tmp ?
            (function() {
      ret.add([
        [pstr,r].join(""),
        tmp,
        ((!noSemi_QUERY) ?
          ";" :
          ""),
        "\n"
      ]);
      return noSemi_QUERY = false;
      })() :
      undefined);
  });
  indent -= tabspace;
  return ret;
  })();
  })();
}
function evalList2(expr) {
  evalConCells(expr);
  let s = null,
    ename = expr[0];
  ((!ename) ?
    syntax_BANG("e1",expr) :
    undefined);
  (REGEX.func.test(ename) ?
    ename = tnodeChunk([
      "(",
      ename,
      ")"
    ]) :
    undefined);
  return tnodeChunk([
    ename,
    "(",
    tnodeChunk(expr.slice(1)).join(","),
    ")"
  ]);
}
function evalList(expr) {
  let cmd = "",
    tmp = null,
    mc = null,
    info = (expr[KIRBY] || {});
  (("object" === (info)["eTYPE"]) ?
    cmd = "{" :
    (("array" === (info)["eTYPE"]) ?
      cmd = "[" :
      (node_QUERY(expr[0]) ?
                (function() {
        cmd = (expr[0])["name"];
        return mc = MACROS_MAP[cmd];
        })() :
        undefined)));
  return ((!((typeof(mc) === "undefined") || (Object.prototype.toString.call(mc) === "[object Null]"))) ?
    eval_QUERY_QUERY(evalMacro(mc,expr)) :
    ((Object.prototype.toString.call(cmd) === "[object String]") ?
      (cmd.startsWith(".-") ?
                (function() {
        let ret = tnode();
        return         (function() {
        ret.add(eval_QUERY_QUERY(expr[1]));
        ret.prepend("(");
        ret.add([
          ")[\"",
          cmd.slice(2),
          "\"]"
        ]);
        return ret;
        })();
        })() :
        ((cmd.charAt(0) === ".") ?
                    (function() {
          let ret = tnode();
          return           (function() {
          ret.add(eval_QUERY_QUERY(expr[1]));
          ret.add([
            expr[0],
            "("
          ]);
          (function () {
for (var i = 2; (i < (expr)["length"]); i = (i + 1)) {
                        (function() {
            ((i !== 2) ?
              ret.add(",") :
              undefined);
            return ret.add(eval_QUERY_QUERY(expr[i]));
            })();
          }
})();
          ret.add(")");
          return ret;
          })();
          })() :
          (SPECIAL_OPS.hasOwnProperty(cmd) ?
            SPECIAL_OPS[cmd](expr) :
            (true ?
              evalList2(expr) :
              undefined)))) :
      (true ?
        evalList2(expr) :
        undefined)));
}
function evalConCells(cells) {
  return cells.forEach(function (cell,i,cc) {
    return ((Object.prototype.toString.call(cell) === "[object Array]") ?
      cc[i] = evalList(cell) :
      undefined);
  });
}
function expandMacro(code,data,frags) {
  let state = null,
    ret = [],
    ename = "",
    tmp = null,
    s1name = "",
    ci = (code[KIRBY] || {}),
    di = (data[KIRBY] || {});
  state = Object.assign(di);
  ret[KIRBY] = state;
  (((Object.prototype.toString.call(code) === "[object Array]") && ((code)["length"] > 1)) ?
        (function() {
    s1name = (code[1])["name"];
    return frag = frags[[TILDA,s1name].join("")];
    })() :
    undefined);
  (((Object.prototype.toString.call(code) === "[object Array]") && ((code && ((code)["length"] > 0)) ?
      code :
      null)) ?
    ename = (code[0])["name"] :
    undefined);
  ((("object" === (ci)["eTYPE"]) || ("array" === (ci)["eTYPE"])) ?
    state["eTYPE"] = ci.eTYPE :
    undefined);
  ename = (ename || "");
  return ((ename === "#<<") ?
    ((!(Object.prototype.toString.call(frag) === "[object Array]")) ?
      syntax_BANG("e13",data,cmd) :
      frag.shift()) :
    ((ename === "#head") ?
      ((!(Object.prototype.toString.call(frag) === "[object Array]")) ?
        syntax_BANG("e13",data,cmd) :
        (((frag && ((frag)["length"] > 0)) ?
            frag :
            null) ?
          frag[0] :
          undefined)) :
      ((ename === "#tail") ?
        ((!(Object.prototype.toString.call(frag) === "[object Array]")) ?
          syntax_BANG("e13",data,cmd) :
          (((frag && ((frag)["length"] > 0)) ?
              frag :
              null) ?
                        (function() {
            let a = frag;
            return a[((a)["length"] - 1)];
            })() :
            undefined)) :
        (ename.startsWith("#evens") ?
                    (function() {
          let r = [];
          return           (function() {
          (function () {
for (var i = 0; (i < (frag)["length"]); i = (i + 2)) {
                        (function() {
            return conj_BANG_BANG(r,frag[i]);
            })();
          }
})();
          (ename.endsWith("*") ?
            r["___split"] = true :
            undefined);
          return r;
          })();
          })() :
          (ename.startsWith("#odds") ?
                        (function() {
            let r = [];
            return             (function() {
            (function () {
for (var i = 1; (i < (frag)["length"]); i = (i + 2)) {
                            (function() {
              return conj_BANG_BANG(r,frag[i]);
              })();
            }
})();
            (ename.endsWith("*") ?
              r["___split"] = true :
              undefined);
            return r;
            })();
            })() :
            (ename.startsWith("#slice@") ?
                            (function() {
              ((!(Object.prototype.toString.call(frag) === "[object Array]")) ?
                syntax_BANG("e13",data,cmd) :
                undefined);
              tmp = REGEX.macroGet.exec(ename);
              return frag.splice((tmp[1] - 1),1)[0];
              })() :
              ((ename === "#if") ?
                                (function() {
                ((!(Object.prototype.toString.call(frag) === "[object Array]")) ?
                  syntax_BANG("e13",data,cmd) :
                  undefined);
                return (((frag && ((frag)["length"] > 0)) ?
                    frag :
                    null) ?
                  expandMacro(code[2],data,frags) :
                  ((((code)["length"] > 3) && code[3]) ?
                    expandMacro(code[3],data,frags) :
                    undefined));
                })() :
                (true ?
                                    (function() {
                  let cell = null;
                  (function () {
for (var i = 0; (i < (code)["length"]); i = (i + 1)) {
                                        (function() {
                    cell = code[i];
                    return ((Object.prototype.toString.call(cell) === "[object Array]") ?
                                            (function() {
                      let c = expandMacro(cell,data,frags);
                      return (((Object.prototype.toString.call(c) === "[object Array]") && (true === c["___split"])) ?
                        (function () {
for (var k = 0; (k < (c)["length"]); k = (k + 1)) {
                                                    (function() {
                          return conj_BANG_BANG(ret,c[k]);
                          })();
                        }
})() :
                        conj_BANG_BANG(ret,c));
                      })() :
                                            (function() {
                      let tn = (cell)["name"],
                        atSign_QUERY = false;
                      tmp = cell;
                      (tn.includes("@") ?
                                                (function() {
                        atSign_QUERY = true;
                        return tmp = tnode(cell.line,cell.column,cell.source,tn.replace("@",""),tn.replace("@",""));
                        })() :
                        undefined);
                      return                       (function() {
                      let repl = frags[tmp.name];
                      return ((!((typeof(repl) === "undefined") || (Object.prototype.toString.call(repl) === "[object Null]"))) ?
                                                (function() {
                        return ((atSign_QUERY || (tmp.name === TILDA_VARGS)) ?
                          (function () {
for (var j = 0; (j < (repl)["length"]); j = (j + 1)) {
                                                        (function() {
                            return conj_BANG_BANG(ret,repl[j]);
                            })();
                          }
})() :
                          conj_BANG_BANG(ret,repl));
                        })() :
                        conj_BANG_BANG(ret,cell));
                      })();
                      })());
                    })();
                  }
})();
                  return ret;
                  })() :
                  undefined))))))));
}
function evalMacro(mc,data) {
  let args = mc["args"],
    cmd = mc["name"],
    code = mc["code"],
    vargs = false,
    tpos = 0,
    i = 0,
    frags = {};
  (function () {
for (var tpos = (i + 1); (i < (args)["length"]); i = (i + 1),tpos = (i + 1)) {
        (function() {
    return (((args[i])["name"] === VARGS) ?
            (function() {
      vargs = true;
      return frags[TILDA_VARGS] = data.slice(tpos);
      })() :
      frags[[TILDA,(args[i])["name"]].join("")] = ((tpos >= (data)["length"]) ?
        tnodeChunk("undefined") :
        data[tpos]));
    })();
  }
})();
  (((!vargs) && ((i + 1) < (data)["length"])) ?
    syntax_BANG("e16",data,cmd) :
    undefined);
  return expandMacro(code,data,frags);
}
function sf_compOp(expr) {
  (((expr)["length"] < 3) ?
    syntax_BANG("e0",expr) :
    undefined);
  evalConCells(expr);
  ((expr[0] == "!=") ?
    expr[0] = "!==" :
    undefined);
  ((expr[0] == "=") ?
    expr[0] = "===" :
    undefined);
  return   (function() {
  let ret = tnode();
  return   (function() {
  (function () {
for (var i = 0,op = expr.shift(); (i < ((expr)["length"] - 1)); i = (i + 1)) {
        (function() {
    return ret.add(tnodeChunk([
      expr[i],
      " ",
      op,
      " ",
      expr[(i + 1)]
    ]));
    })();
  }
})();
  ret.join(" && ");
  ret.prepend("(");
  ret.add(")");
  return ret;
  })();
  })();
}
[
  "!=",
  "==",
  "=",
  ">",
  ">=",
  "<",
  "<="
].forEach(function (k) {
  return SPECIAL_OPS[k] = sf_compOp;
});
function sf_arithOp(expr) {
  (((expr)["length"] < 2) ?
    syntax_BANG("e0",expr) :
    undefined);
  evalConCells(expr);
  let op = tnode(),
    e1 = expr.shift(),
    cmd = (e1)["name"];
  return   (function() {
  let ret = tnode();
  return   (function() {
  ((1 === (expr)["length"]) ?
    (("-" === cmd) ?
      ret.add("-") :
      undefined) :
    op.add([
      " ",
      e1,
      " "
    ]));
  ret.add(expr);
  (((expr)["length"] > 1) ?
    ret.join(op) :
    undefined);
  ret.prepend("(");
  ret.add(")");
  return ret;
  })();
  })();
}
[
  "+",
  "-",
  "*",
  "/",
  "%"
].forEach(function (k) {
  return SPECIAL_OPS[k] = sf_arithOp;
});
function sf_logicalOp(expr) {
  return sf_arithOp(expr);
}
[
  "||",
  "&&",
  "^",
  "|",
  "&",
  ">>>",
  ">>",
  "<<"
].forEach(function (k) {
  return SPECIAL_OPS[k] = sf_logicalOp;
});
function sf_repeat(expr) {
  assertArgs(expr,3,"e0");
  evalConCells(expr);
  return   (function() {
  let ret = tnode();
  return   (function() {
  (function () {
for (var i = 0,end = parseInt((expr[1])["name"]); (i < end); i = (i + 1)) {
        (function() {
    ((i !== 0) ?
      ret.add(",") :
      undefined);
    return ret.add(expr[2]);
    })();
  }
})();
  ret.prepend("[");
  ret.add("]");
  return ret;
  })();
  })();
}
SPECIAL_OPS["repeat-n"] = sf_repeat;
function sf_do(expr) {
  let p = pad(indent),
    e = null,
    end = ((expr)["length"] - 1);
  return   (function() {
  let ret = tnode();
  return   (function() {
  (function () {
for (var i = 1; (i < end); i = (i + 1)) {
        (function() {
    e = expr[i];
    return ret.add([
      p,
      evalList(e),
      ";\n"
    ]);
    })();
  }
})();
  ((end > 0) ?
        (function() {
    e = eval_QUERY_QUERY(    (function() {
    let a = expr;
    return a[((a)["length"] - 1)];
    })());
    ret.add([
      p,
      "return ",
      e,
      ";\n"
    ]);
    ret.prepend([p,"(function() {\n"].join(""));
    return ret.add([p,"})()"].join(""));
    })() :
    undefined);
  return ret;
  })();
  })();
}
SPECIAL_OPS["do"] = sf_do;
function sf_doto(expr) {
  (((expr)["length"] < 2) ?
    syntax_BANG("e0",expr) :
    undefined);
  let p = pad(indent),
    p2 = pad((indent + tabspace)),
    p3 = pad((indent + (2 * tabspace))),
    e = null,
    e1 = eval_QUERY_QUERY(expr[1]);
  return   (function() {
  let ret = tnode();
  return   (function() {
  ret.add([
    p2,
    "let ____x = ",
    e1,
    ";\n"
  ]);
  (function () {
for (var i = 2; (i < (expr)["length"]); i = (i + 1)) {
        (function() {
    e = expr[i];
    e.splice(1,0,"____x");
    return ret.add([
      p3,
      evalList(e),
      ";\n"
    ]);
    })();
  }
})();
  ret.add([
    p2,
    "return ____x;\n"
  ]);
  ret.prepend([p,"(function() {\n"].join(""));
  ret.add([p,"})()"].join(""));
  return ret;
  })();
  })();
}
SPECIAL_OPS["doto"] = sf_doto;
function sf_range(expr) {
  ((((expr)["length"] < 2) || ((expr)["length"] > 4)) ?
    syntax_BANG("e0",expr) :
    undefined);
  let len = 0,
    start = 0,
    step = 1,
    end = 0;
  evalConCells(expr);
  len = (expr)["length"];
  end = parseInt((expr[1])["name"]);
  return   (function() {
  let ret = tnode();
  return   (function() {
  ((len > 2) ?
        (function() {
    start = parseInt((expr[1])["name"]);
    return end = parseInt((expr[2])["name"]);
    })() :
    undefined);
  ((len > 3) ?
    step = parseInt((expr[3])["name"]) :
    undefined);
  (function () {
for (var i = start; (i < end); i = (i + step)) {
        (function() {
    ((i !== start) ?
      ret.add(",") :
      undefined);
    return ret.add(["",i].join(""));
    })();
  }
})();
  ret.prepend("[");
  ret.add("]");
  return ret;
  })();
  })();
}
SPECIAL_OPS["range"] = sf_range;
function sf_var(expr,cmd) {
  ((((expr)["length"] < 3) || (0 === ((expr)["length"] % 2))) ?
    syntax_BANG("e0",expr) :
    undefined);
  (((expr)["length"] > 3) ?
    indent += tabspace :
    undefined);
  evalConCells(expr);
  return   (function() {
  let ret = tnode();
  return   (function() {
  (function () {
for (var i = 1; (i < (expr)["length"]); i = (i + 2)) {
        (function() {
    ((i > 1) ?
      ret.add([",\n",pad(indent)].join("")) :
      undefined);
    ((!testid_QUERY(expr[i])) ?
      syntax_BANG("e9",expr) :
      undefined);
    return ret.add([
      expr[i],
      " = ",
      expr[(i + 1)]
    ]);
    })();
  }
})();
  ret.prepend(" ");
  ret.prepend(cmd);
  (((expr)["length"] > 3) ?
    indent -= tabspace :
    undefined);
  return ret;
  })();
  })();
}
SPECIAL_OPS["var"] = function (x) {
  return sf_var(x,"let");
};
SPECIAL_OPS["def"] = function (x) {
  return sf_var(x,"var");
};
SPECIAL_OPS["def-"] = SPECIAL_OPS["def"];
function sf_new(expr) {
  (((expr)["length"] < 2) ?
    syntax_BANG("e0",expr) :
    undefined);
  return   (function() {
  let ret = tnode();
  return   (function() {
  ret.add(evalList(expr.slice(1)));
  ret.prepend("new ");
  return ret;
  })();
  })();
}
SPECIAL_OPS["new"] = sf_new;
function sf_throw(expr) {
  assertArgs(expr,2,"e0");
  return   (function() {
  let ret = tnode();
  return   (function() {
  ret.add(eval_QUERY_QUERY(expr[1]));
  ret.prepend("throw ");
  return ret;
  })();
  })();
}
SPECIAL_OPS["throw"] = sf_throw;
function sf_while(expr) {
  let f1 = expr[1];
  expr.splice(0,2,tnodeChunk("do","do"));
  return   (function() {
  let ret = null;
  return   (function() {
  ret = tnodeChunk([
    "while ",
    eval_QUERY_QUERY(f1),
    " {\n",
    evalList(expr),
    ";\n}\n"
  ]);
  ret.prepend("(function () {\n");
  ret.add("})()");
  return ret;
  })();
  })();
}
SPECIAL_OPS["while"] = sf_while;
function sf_x_opop(expr,op) {
  (((expr)["length"] !== 2) ?
    syntax_BANG("e0",expr) :
    undefined);
  return tnodeChunk([
    op,
    eval_QUERY_QUERY(expr[1])
  ]);
}
SPECIAL_OPS["dec!!"] = function (x) {
  return sf_x_opop(x,"--");
};
SPECIAL_OPS["inc!!"] = function (x) {
  return sf_x_opop(x,"++");
};
function sf_x_eq(expr,op) {
  assertArgs(expr,3,"e0");
  return tnodeChunk([
    expr[1],
    [" ",op,"= "].join(""),
    eval_QUERY_QUERY(expr[2])
  ]);
}
SPECIAL_OPS["dec!"] = function (x) {
  return sf_x_eq(x,"-");
};
SPECIAL_OPS["inc!"] = function (x) {
  return sf_x_eq(x,"+");
};
function sf_set(expr) {
  ((!(((expr)["length"] === 3) || ((expr)["length"] === 4))) ?
    syntax_BANG("e0",expr) :
    undefined);
  return   (function() {
  let ret = tnode();
  return   (function() {
  (((expr)["length"] === 4) ?
        (function() {
    ret.add(eval_QUERY_QUERY(expr[1]));
    ret.add("[");
    ret.add(eval_QUERY_QUERY(expr[2]));
    return ret.add("]");
    })() :
    ret.add(expr[1]));
  ret.add([
    " = ",
    eval_QUERY_QUERY(    (function() {
    let a = expr;
    return a[((a)["length"] - 1)];
    })())
  ]);
  return ret;
  })();
  })();
}
SPECIAL_OPS["aset"] = sf_set;
SPECIAL_OPS["set!"] = sf_set;
function sf_anonFunc(expr) {
  (((expr)["length"] < 2) ?
    syntax_BANG("e0",expr) :
    undefined);
  ((!(Object.prototype.toString.call(expr[1]) === "[object Array]")) ?
    syntax_BANG("e0",expr) :
    undefined);
  let fArgs = expr[1],
    fBody = expr.slice(2);
  return   (function() {
  let ret = tnodeChunk(fArgs);
  return   (function() {
  ret.join(",");
  ret.prepend("function (");
  ret.add([
    ") {\n",
    parseTree(fBody),
    pad(indent),
    "}"
  ]);
  return ret;
  })();
  })();
}
SPECIAL_OPS["fn"] = sf_anonFunc;
function sf_func(expr,public_QUERY) {
  (((expr)["length"] < 2) ?
    syntax_BANG("e0",expr) :
    undefined);
  let fName = null,
    fArgs = null,
    fBody = null;
  return   (function() {
  let ret = null;
  return   (function() {
  (((!(Object.prototype.toString.call(expr[1]) === "[object Array]")) && (Object.prototype.toString.call(expr[2]) === "[object Array]")) ?
        (function() {
    fName = normalizeId((expr[1])["name"]);
    fArgs = expr[2];
    return fBody = expr.slice(3);
    })() :
    syntax_BANG("e0",expr));
  ret = tnodeChunk(fArgs);
  ret.join(",");
  ret.prepend(["function ",fName,"("].join(""));
  ret.add([
    ") {\n",
    parseTree(fBody),
    pad(indent),
    "}"
  ]);
  noSemi_QUERY = true;
  return ret;
  })();
  })();
}
SPECIAL_OPS["defn-"] = function (x) {
  return sf_func(x,false);
};
SPECIAL_OPS["defn"] = function (x) {
  return sf_func(x,true);
};
function sf_try(expr) {
  let sz = (expr)["length"],
    t = null,
    f = null,
    c = null,
    ind = pad(indent);
  f =   (function() {
  let a = expr;
  return a[((a)["length"] - 1)];
  })();
  (((Object.prototype.toString.call(f) === "[object Array]") && ((f[0])["name"] === "finally")) ?
        (function() {
    f = expr.pop();
    return sz = (expr)["length"];
    })() :
    f = null);
  c = ((sz > 1) ?
    expr[(sz - 1)] :
    null);
  (((Object.prototype.toString.call(c) === "[object Array]") && ((c[0])["name"] === "catch")) ?
        (function() {
    ((((c)["length"] < 2) || (!node_QUERY(c[1]))) ?
      syntax_BANG("e0",expr) :
      undefined);
    return c = expr.pop();
    })() :
    c = null);
  (((Object.prototype.toString.call(f) === "[object Null]") && (Object.prototype.toString.call(c) === "[object Null]")) ?
    syntax_BANG("e0",expr) :
    undefined);
  return   (function() {
  let ret = tnodeChunk([
    ["(function() {\n",ind,"try {\n"].join(""),
    parseTree(expr.slice(1)),
    ["\n",ind,"} "].join("")
  ]);
  return   (function() {
  (c ?
        (function() {
    t = c[1];
    c.splice(0,2,tnodeChunk("do","do"));
    return ret.add([
      ["catch (",t,") {\n"].join(""),
      "return ",
      evalList(c),
      [";\n",ind,"}\n"].join("")
    ]);
    })() :
    undefined);
  (f ?
        (function() {
    f.splice(0,1,tnodeChunk("do","do"));
    return ret.add([
      "finally {\n",
      evalList(f),
      [";\n",ind,"}\n"].join("")
    ]);
    })() :
    undefined);
  ret.add([ind,"})()"].join(""));
  return ret;
  })();
  })();
}
SPECIAL_OPS["try"] = sf_try;
function sf_if(expr) {
  ((((expr)["length"] < 3) || ((expr)["length"] > 4)) ?
    syntax_BANG("e0",expr) :
    undefined);
  indent += tabspace;
  evalConCells(expr);
  return (function() {
  try {
    return tnodeChunk([
      "(",
      expr[1],
      [" ?\n",pad(indent)].join(""),
      expr[2],
      [" :\n",pad(indent)].join(""),
      (expr[3] || "undefined"),
      ")"
    ]);

  } finally {
  (function() {
  return indent -= tabspace;
  })();
  }
  })();
}
SPECIAL_OPS["if"] = sf_if;
function sf_get(expr) {
  assertArgs(expr,3,"e0");
  evalConCells(expr);
  return tnodeChunk([
    expr[1],
    "[",
    expr[2],
    "]"
  ]);
}
SPECIAL_OPS["get"] = sf_get;
SPECIAL_OPS["aget"] = SPECIAL_OPS["get"];
function sf_str(expr) {
  (((expr)["length"] < 2) ?
    syntax_BANG("e0",expr) :
    undefined);
  evalConCells(expr);
  return   (function() {
  let ret = tnode();
  return   (function() {
  ret.add(expr.slice(1));
  ret.join(",");
  ret.prepend("[");
  ret.add("].join('')");
  return ret;
  })();
  })();
}
SPECIAL_OPS["str"] = sf_str;
function sf_array(expr) {
  let info = (expr[KIRBY] || {}),
    p = pad(indent),
    epilog = ["\n",p,"]"].join("");
  return   (function() {
  let ret = tnode();
  return   (function() {
  ((expr ?
      (0 === (expr)["length"]) :
      false) ?
    ret.add("[]") :
    (function() {
    try {
      (("array" !== (info)["eTYPE"]) ?
        expr.splice(0,1) :
        undefined);
      indent += tabspace;
      evalConCells(expr);
      p = pad(indent);
      ret.add(["[\n",p].join(""));
      (function () {
for (var i = 0; (i < (expr)["length"]); i = (i + 1)) {
                (function() {
        ((i > 0) ?
          ret.add([",\n",p].join("")) :
          undefined);
        return ret.add(expr[i]);
        })();
      }
})();
      return ret.add(epilog);

    } finally {
    (function() {
    return indent -= tabspace;
    })();
    }
    })());
  return ret;
  })();
  })();
}
SPECIAL_OPS["["] = sf_array;
SPECIAL_OPS["vec"] = SPECIAL_OPS["["];
function sf_object(expr) {
  let info = (expr[KIRBY] || {}),
    p = pad(indent),
    epilog = ["\n",p,"}"].join("");
  return   (function() {
  let ret = tnode();
  return   (function() {
  ((expr ?
      (0 === (expr)["length"]) :
      false) ?
    ret.add("{}") :
    (function() {
    try {
      (("object" !== (info)["eTYPE"]) ?
        expr.splice(0,1) :
        undefined);
      indent += tabspace;
      evalConCells(expr);
      p = pad(indent);
      ret.add(["{\n",p].join(""));
      (function () {
for (var i = 0; (i < (expr)["length"]); i = (i + 2)) {
                (function() {
        ((i > 0) ?
          ret.add([",\n",p].join("")) :
          undefined);
        return ret.add([
          expr[i],
          ": ",
          expr[(i + 1)]
        ]);
        })();
      }
})();
      return ret.add(epilog);

    } finally {
    (function() {
    return indent -= tabspace;
    })();
    }
    })());
  return ret;
  })();
  })();
}
SPECIAL_OPS["{"] = sf_object;
SPECIAL_OPS["hash-map"] = SPECIAL_OPS["{"];
var includeFile = (function () {
  let icache = [];
  return function (fname) {
    return ((icache.indexOf(fname) !== -1) ?
      "" :
            (function() {
      icache.push(fname);
      return parseTree(toASTree(_STARfs_STAR.readFileSync(fname),fname));
      })());
  };
})();
function sf_include(expr) {
  assertArgs(expr,2,"e0");
  let found = false,
    fname = (expr[1])["name"],
    info = (expr[KIRBY] || {});
  ((Object.prototype.toString.call(fname) === "[object String]") ?
    fname = fname.replace(new RegExp("[\"]","g"),"") :
    undefined);
  indent -= tabspace;
  includePaths.concat([
    _STARpath_STAR.dirname(info.filename)
  ]).forEach(function (pfx) {
    return (function() {
    try {
      return ((!found) ?
                (function() {
        fname = _STARfs_STAR.realpathSync([pfx,"/",fname].join(""));
        return found = true;
        })() :
        undefined);

    } catch (e) {
return     (function() {
    return undefined;
    })();
    }
    })();
  });
  ((!found) ?
    syntax_BANG("e11",expr) :
    undefined);
  return (function() {
  try {
    return includeFile(fname);

  } finally {
  (function() {
  return indent += tabspace;
  })();
  }
  })();
}
SPECIAL_OPS["include"] = sf_include;
function sf_ns(expr) {
  return "";
}
SPECIAL_OPS["ns"] = sf_ns;
function sf_comment(expr) {
  return "";
}
SPECIAL_OPS["comment"] = sf_comment;
function sf_floop(expr) {
  (((expr)["length"] < 2) ?
    syntax_BANG("e0",expr) :
    undefined);
  let c1 = null,
    c2 = null,
    c3 = null,
    c = expr[1],
    ind = pad(indent);
  return   (function() {
  let ret = tnodeChunk("for (");
  return   (function() {
  (((!(Object.prototype.toString.call(c) === "[object Array]")) || ((c)["length"] !== 3)) ?
    syntax_BANG("e0",expr) :
    undefined);
  c1 = c[0];
  c2 = c[1];
  c3 = c[2];
  indent += tabspace;
  (function () {
for (var i = 0; (i < (c1)["length"]); i = (i + 2)) {
        (function() {
    ((i === 0) ?
      ret.add("var ") :
      undefined);
    ((i !== 0) ?
      ret.add(",") :
      undefined);
    return ret.add([
      c1[i],
      " = ",
      eval_QUERY_QUERY(c1[(i + 1)])
    ]);
    })();
  }
})();
  ret.add("; ");
  ret.add(evalList(c2));
  ret.add("; ");
  (function () {
for (var i = 0; (i < (c3)["length"]); i = (i + 2)) {
        (function() {
    ((i !== 0) ?
      ret.add(",") :
      undefined);
    return ret.add([
      c3[i],
      " = ",
      eval_QUERY_QUERY(c3[(i + 1)])
    ]);
    })();
  }
})();
  ret.add(") {\n");
  (((expr)["length"] > 2) ?
        (function() {
    expr.splice(0,2,tnodeChunk("do","do"));
    return ret.add([
      ind,
      pad(tabspace),
      evalList(expr),
      ";"
    ]);
    })() :
    undefined);
  ret.add(["\n",ind,"}\n"].join(""));
  ret.prepend("(function () {\n");
  ret.add("})()");
  indent -= tabspace;
  return ret;
  })();
  })();
}
SPECIAL_OPS["for"] = sf_floop;
function sf_jscode(expr) {
  assertArgs(expr,2,"e0");
  noSemi_QUERY = true;
  expr[1].replaceRight(new RegExp("\"","g"),"");
  return expr[1];
}
SPECIAL_OPS["js#"] = sf_jscode;
function sf_macro(expr) {
  assertArgs(expr,4,"e0");
  let a2 = expr[2],
    a3 = expr[3],
    cmd = (expr[1])["name"];
  return   (function() {
  let ret = "";
  return   (function() {
  (function () {
for (var i = 0; (i < (a2)["length"]); i = (i + 1)) {
        (function() {
    return ((((a2[i])["name"] === VARGS) && ((i + 1) !== (a2)["length"])) ?
      syntax_BANG("e15",expr,cmd) :
      undefined);
    })();
  }
})();
  a2[KIRBY] = {
    eTYPE: null
  };
  a3[KIRBY] = {
    eTYPE: null
  };
  MACROS_MAP[cmd] = {
    args: a2,
    code: a3,
    name: cmd
  };
  return ret;
  })();
  })();
}
SPECIAL_OPS["defmacro"] = sf_macro;
function sf_not(expr) {
  assertArgs(expr,2,"e0");
  evalConCells(expr);
  return ["(!",expr[1],")"].join("");
}
SPECIAL_OPS["!"] = sf_not;
function dbg(obj,hint) {
  return ((Object.prototype.toString.call(obj) === "[object Array]") ?
        (function() {
    hint = (hint || "block");
    console.log(["<",hint,">"].join(""));
    (function () {
for (var i = 0; (i < (obj)["length"]); i = (i + 1)) {
            (function() {
      return dbg(obj[i]);
      })();
    }
})();
    return console.log(["</",hint,">"].join(""));
    })() :
    (node_QUERY(obj) ?
            (function() {
      console.log("<node>");
      console.log(obj);
      dbg(obj.children,"subs");
      return console.log("</node>");
      })() :
      (true ?
        console.log(obj) :
        undefined)));
}
function dbgAST(codeStr,fname) {
  return dbg(toASTree(codeStr,fname),"tree");
}
function compileCode(codeStr,fname,withSrcMap_QUERY,incPaths) {
  ((!loadedMacros_QUERY) ?
        (function() {
    loadedMacros_QUERY = true;
    return require("./macros.kirby");
    })() :
    undefined);
  ((Object.prototype.toString.call(incPaths) === "[object Array]") ?
    includePaths = incPaths :
    undefined);
  indent = (-tabspace);
  let outNode = parseTree(toASTree(codeStr,fname));
  outNode.prepend(MODULE_BANNER);
  return (withSrcMap_QUERY ?
        (function() {
    let outFile = [_STARpath_STAR.basename(fname,".kirby"),".js"].join(""),
      srcMap = [outFile,".map"].join(""),
      output = outNode.toStringWithSourceMap({
        file: outFile
      });
    fs.writeFileSync(srcMap,output.map);
    return [output.code,"\n//# sourceMappingURL=",_STARpath_STAR.relative(_STARpath_STAR.dirname(fname),srcMap)].join("");
    })() :
    outNode.toString());
}
function transpileXXX(code,file,smap_QUERY,incDirs) {
  return (function() {
  try {
    return compileCode(code,file,smap_QUERY,incDirs);

  } catch (e) {
return   (function() {
  console.log(e.stack);;
  throw e;;
  return null;
  })();
  }
  })()
}
function transpileWithSrcMap(code,file,incDirs) {
  return transpileXXX(code,file,true,incDirs);
}
function transpile(code,file,incDirs) {
  return transpileXXX(code,file,false,incDirs);
}
function parseWithSourceMap(codeStr,fname) {
  let outNode = parseTree(toASTree(codeStr,fname));
  outNode.prepend(MODULE_BANNER);
  return outNode.toStringWithSourceMap();
}
(function() {
let exports = {};
return (function() {
exports["transpileWithSrcMap"] = transpileWithSrcMap;
exports["parseWithSourceMap"] = parseWithSourceMap;
exports["transpile"] = transpile;
exports["version"] = MODULE_VERSION;
exports["dbgAST"] = dbgAST;
module.exports = exports;
return exports;
})();
})();
